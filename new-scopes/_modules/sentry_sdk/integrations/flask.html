<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>sentry_sdk.integrations.flask - sentry-python 1.31.0 documentation</title>
    <link rel="index" title="Index" href="../../../genindex.html" /><link rel="search" title="Search" href="../../../search.html" />
  <script>
    const isDarkTheme = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    const sessionTheme = sessionStorage['_theme']
    if (sessionTheme) {
      document.documentElement.classList.add(sessionTheme)
    } else if (isDarkTheme) {
      document.documentElement.classList.add('dark')
    }
  </script><link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=aecf457f" />
    <link rel="stylesheet" type="text/css" href="../../../_static/shibuya.css?v=2981b36d" />
    <link media="print" rel="stylesheet" type="text/css" href="../../../_static/print.css?v=ee381b95" />
    <style>
:root {
  --sy-f-sys:-apple-system, BlinkMacSystemFont, Segoe UI, Oxygen, Ubuntu, Droid Sans, Helvetica Neue;--sy-f-cjk:PingFang SC, Hiragino Sans GB, Droid Sans Fallback, Microsoft YaHei;--sy-f-heading:var(--sy-f-sys), var(--sy-f-cjk), sans-serif;--sy-f-text:var(--sy-f-sys), var(--sy-f-cjk), sans-serif;--sy-f-mono:Menlo, Monaco, Consolas, "Courier New", monospace;--sy-c-divider:rgba(var(--sy-rc-text), 0.1);--sy-c-divider-weak:rgba(var(--sy-rc-text), 0.05);--sy-c-border:rgba(var(--sy-rc-text), 0.14);--sy-s-banner-height:0rem;--sy-s-navbar-height:56px;--sy-s-offset-top:calc(var(--sy-s-navbar-height) + var(--sy-s-banner-height));--sy-c-link:rgb(var(--sy-rc-theme));--sy-c-link-weak:rgba(var(--sy-rc-theme), 0.86);
  --sy-rc-theme:143, 118, 214;--sy-rc-bg:255, 255, 255;--sy-rc-invert:0, 0, 0;--sy-rc-text:0, 0, 0;--sy-c-bg:#fff;--sy-c-bg-weak:#f9f9f9;--sy-c-text:#374151;--sy-c-text-weak:#6b7280;--sy-c-heading:#111827;--sy-c-bold:#111827;--sy-c-foot-text:#232226;--sy-c-foot-bg:#fafafa;--sy-c-foot-divider:#f0f0f0;
}
@media (prefers-color-scheme: light) {
  :root {
    --sy-rc-theme:143, 118, 214;--sy-rc-bg:255, 255, 255;--sy-rc-invert:0, 0, 0;--sy-rc-text:0, 0, 0;--sy-c-bg:#fff;--sy-c-bg-weak:#f9f9f9;--sy-c-text:#374151;--sy-c-text-weak:#6b7280;--sy-c-heading:#111827;--sy-c-bold:#111827;--sy-c-foot-text:#232226;--sy-c-foot-bg:#fafafa;--sy-c-foot-divider:#f0f0f0;
  }
}
@media (prefers-color-scheme: dark) {
  :root {
    --sy-rc-theme:143, 118, 214;--sy-rc-bg:18, 18, 18;--sy-rc-invert:255, 255, 255;--sy-rc-text:255, 255, 255;--sy-c-bg:#121212;--sy-c-bg-weak:#212833;--sy-c-text:#cedbea;--sy-c-text-weak:#77889f;--sy-c-heading:#ebf0f4;--sy-c-bold:#ebf0f4;--sy-c-foot-text:#eee;--sy-c-foot-bg:#000;--sy-c-foot-divider:#000;
  }
}
html.light {
  --sy-rc-theme:143, 118, 214;--sy-rc-bg:255, 255, 255;--sy-rc-invert:0, 0, 0;--sy-rc-text:0, 0, 0;--sy-c-bg:#fff;--sy-c-bg-weak:#f9f9f9;--sy-c-text:#374151;--sy-c-text-weak:#6b7280;--sy-c-heading:#111827;--sy-c-bold:#111827;--sy-c-foot-text:#232226;--sy-c-foot-bg:#fafafa;--sy-c-foot-divider:#f0f0f0;
}
html.dark {
  --sy-rc-theme:143, 118, 214;--sy-rc-bg:18, 18, 18;--sy-rc-invert:255, 255, 255;--sy-rc-text:255, 255, 255;--sy-c-bg:#121212;--sy-c-bg-weak:#212833;--sy-c-text:#cedbea;--sy-c-text-weak:#77889f;--sy-c-heading:#ebf0f4;--sy-c-bold:#ebf0f4;--sy-c-foot-text:#eee;--sy-c-foot-bg:#000;--sy-c-foot-divider:#000;
}
</style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --sy-f-heading: Inter, var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
}
</style>
    <meta property="og:type" content="website"/><meta property="og:title" content="sentry_sdk.integrations.flask"/>
<meta name="twitter:card" content="summary"/></head>
<body><div class="document"><div class="sy-head">
  <div class="sy-head-blur"></div>
  <div class="sy-head-inner sy-container mx-auto">
    <a class="sy-head-brand mr-4" href="../../../index.html">
      
      
      <strong>sentry-python</strong>
    </a>
    <div class="sy-head-links" id="NavLinks">
      <nav class="sy-head-nav"></nav>
      <div class="sy-head-extra flex items-center print:hidden"><form class="searchbox flex items-center" action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <kbd>/</kbd>
</form>
        
        
        <div class="sy-head-social flex items-center">
            <a class="flex items-center" href="https://github.com/getsentry/sentry-python" aria-label="GitHub">
              <i class="i-icon github"></i>
            </a>
        </div>
      </div>
    </div>
    <div class="sy-head-actions flex items-center shrink-0 print:hidden">
      <button class="js-theme theme-switch flex items-center" data-aria-light="Switch to dark mode" data-aria-dark="Switch to light mode">
        <i class="i-icon theme-icon"></i>
      </button>
      <button class="md:hidden flex items-center js-menu" aria-label="Menu" type="button" aria-controls="NavLinks" aria-expanded="false">
        <div class="hamburger">
          <span class="hamburger_1"></span>
          <span class="hamburger_2 -translate-x-2"></span>
          <span class="hamburger_3 -translate-x-1"></span>
        </div>
      </button>
    </div>
  </div>
</div>
<div class="sy-page sy-container flex mx-auto">
  <aside id="lside" class="sy-lside md:w-72 md:shrink-0 print:hidden">
    <div class="sy-lside-inner md:sticky">
      <div class="sy-scrollbar p-6">
        <div class="globaltoc" data-expand-depth="0"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">Main API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../integrations.html">Integrations</a></li>
</ul>

        </div>
      </div>
      
    </div>
  </aside>
  <div class="lside-overlay js-menu" role="button" aria-label="Close left sidebar" aria-controls="lside" aria-expanded="false"></div>
  <aside id="rside" class="sy-rside pb-3 w-64 shrink-0 order-last">
    <button class="rside-close js-menu xl:hidden" aria-label="Close Table of Contents" type="button" aria-controls="rside" aria-expanded="false">
      <i class="i-icon close"></i>
    </button>
    <div class="sy-scrollbar sy-rside-inner px-6 xl:top-16 xl:sticky xl:pl-0 pt-6 pb-4"><div id="ethical-ad-placement" data-ea-publisher="readthedocs"></div>
    </div>
  </aside>
  <div class="rside-overlay js-menu" role="button" aria-label="Close Table of Contents" aria-controls="rside" aria-expanded="false"></div>
  <main class="sy-main w-full max-sm:max-w-full print:pt-6">
    <div class="sy-breadcrumbs" role="navigation">
  <div class="sy-breadcrumbs-inner flex items-center">
    <div class="md:hidden mr-3">
      <button class="js-menu" aria-label="Menu" type="button" aria-controls="lside" aria-expanded="false">
        <i class="i-icon menu"></i>
      </button>
    </div>
    <ul class="flex-1">
      
      
      <li><a href="../../../index.html">sentry-python</a><span>/</span></li>
      
      <li><a href="../../index.html">Module code</a><span>/</span></li>
      
      <li><strong>sentry_sdk.integrations.flask</strong></li>
      
      
    </ul>
    <div class="xl:hidden ml-1">
      <button class="js-menu" aria-label="Show table of contents" type="button" aria-controls="rside"
        aria-expanded="false">
        <i class="i-icon outdent"></i>
      </button>
    </div>
  </div>
</div>
    <div class="flex flex-col break-words justify-between">
      <div class="min-w-0 max-w-6xl px-6 pb-6 pt-8 xl:px-12">
        <article class="yue" role="main">
          <h1>Source code for sentry_sdk.integrations.flask</h1><div class="highlight"><pre>
<span></span><span id="1-1"><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>
</span><span id="1-2">
</span><span id="1-3"><span class="kn">from</span> <span class="nn">sentry_sdk._types</span> <span class="kn">import</span> <span class="n">TYPE_CHECKING</span>
</span><span id="1-4"><span class="kn">from</span> <span class="nn">sentry_sdk.hub</span> <span class="kn">import</span> <span class="n">Hub</span><span class="p">,</span> <span class="n">_should_send_default_pii</span>
</span><span id="1-5"><span class="kn">from</span> <span class="nn">sentry_sdk.integrations</span> <span class="kn">import</span> <span class="n">DidNotEnable</span><span class="p">,</span> <span class="n">Integration</span>
</span><span id="1-6"><span class="kn">from</span> <span class="nn">sentry_sdk.integrations._wsgi_common</span> <span class="kn">import</span> <span class="n">RequestExtractor</span>
</span><span id="1-7"><span class="kn">from</span> <span class="nn">sentry_sdk.integrations.wsgi</span> <span class="kn">import</span> <span class="n">SentryWsgiMiddleware</span>
</span><span id="1-8"><span class="kn">from</span> <span class="nn">sentry_sdk.integrations.modules</span> <span class="kn">import</span> <span class="n">_get_installed_modules</span>
</span><span id="1-9"><span class="kn">from</span> <span class="nn">sentry_sdk.scope</span> <span class="kn">import</span> <span class="n">Scope</span>
</span><span id="1-10"><span class="kn">from</span> <span class="nn">sentry_sdk.tracing</span> <span class="kn">import</span> <span class="n">SOURCE_FOR_STYLE</span>
</span><span id="1-11"><span class="kn">from</span> <span class="nn">sentry_sdk.utils</span> <span class="kn">import</span> <span class="p">(</span>
</span><span id="1-12">    <span class="n">capture_internal_exceptions</span><span class="p">,</span>
</span><span id="1-13">    <span class="n">event_from_exception</span><span class="p">,</span>
</span><span id="1-14">    <span class="n">parse_version</span><span class="p">,</span>
</span><span id="1-15"><span class="p">)</span>
</span><span id="1-16">
</span><span id="1-17"><span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span id="1-18">    <span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Union</span>
</span><span id="1-19">
</span><span id="1-20">    <span class="kn">from</span> <span class="nn">sentry_sdk._types</span> <span class="kn">import</span> <span class="n">EventProcessor</span>
</span><span id="1-21">    <span class="kn">from</span> <span class="nn">sentry_sdk.integrations.wsgi</span> <span class="kn">import</span> <span class="n">_ScopedResponse</span>
</span><span id="1-22">    <span class="kn">from</span> <span class="nn">werkzeug.datastructures</span> <span class="kn">import</span> <span class="n">FileStorage</span><span class="p">,</span> <span class="n">ImmutableMultiDict</span>
</span><span id="1-23">
</span><span id="1-24">
</span><span id="1-25"><span class="k">try</span><span class="p">:</span>
</span><span id="1-26">    <span class="kn">import</span> <span class="nn">flask_login</span>  <span class="c1"># type: ignore</span>
</span><span id="1-27"><span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
</span><span id="1-28">    <span class="n">flask_login</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="1-29">
</span><span id="1-30"><span class="k">try</span><span class="p">:</span>
</span><span id="1-31">    <span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">Request</span>  <span class="c1"># type: ignore</span>
</span><span id="1-32">    <span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">request</span> <span class="k">as</span> <span class="n">flask_request</span>
</span><span id="1-33">    <span class="kn">from</span> <span class="nn">flask.signals</span> <span class="kn">import</span> <span class="p">(</span>
</span><span id="1-34">        <span class="n">before_render_template</span><span class="p">,</span>
</span><span id="1-35">        <span class="n">got_request_exception</span><span class="p">,</span>
</span><span id="1-36">        <span class="n">request_started</span><span class="p">,</span>
</span><span id="1-37">    <span class="p">)</span>
</span><span id="1-38">    <span class="kn">from</span> <span class="nn">markupsafe</span> <span class="kn">import</span> <span class="n">Markup</span>
</span><span id="1-39"><span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
</span><span id="1-40">    <span class="k">raise</span> <span class="n">DidNotEnable</span><span class="p">(</span><span class="s2">&quot;Flask is not installed&quot;</span><span class="p">)</span>
</span><span id="1-41">
</span><span id="1-42"><span class="k">try</span><span class="p">:</span>
</span><span id="1-43">    <span class="kn">import</span> <span class="nn">blinker</span>  <span class="c1"># noqa</span>
</span><span id="1-44"><span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
</span><span id="1-45">    <span class="k">raise</span> <span class="n">DidNotEnable</span><span class="p">(</span><span class="s2">&quot;blinker is not installed&quot;</span><span class="p">)</span>
</span><span id="1-46">
</span><span id="1-47"><span class="n">TRANSACTION_STYLE_VALUES</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;endpoint&quot;</span><span class="p">,</span> <span class="s2">&quot;url&quot;</span><span class="p">)</span>
</span><span id="1-48">
</span><span id="1-49">
<div class="viewcode-block" id="FlaskIntegration">
<a class="viewcode-back" href="../../../integrations.html#sentry_sdk.integrations.flask.FlaskIntegration">[docs]</a>
</span><span id="1-50"><span class="k">class</span> <span class="nc">FlaskIntegration</span><span class="p">(</span><span class="n">Integration</span><span class="p">):</span>
</span><span id="1-51"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="1-52"><span class="sd">    Adds automatic instrumentation for Flask applications.</span>
</span><span id="1-53">
</span><span id="1-54"><span class="sd">    This integration is automatically installed.</span>
</span><span id="1-55"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-56">    <span class="n">identifier</span> <span class="o">=</span> <span class="s2">&quot;flask&quot;</span>
</span><span id="1-57">
</span><span id="1-58">    <span class="n">transaction_style</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="1-59">
</span><span id="1-60">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction_style</span><span class="o">=</span><span class="s2">&quot;endpoint&quot;</span><span class="p">):</span>
</span><span id="1-61">        <span class="c1"># type: (str) -&gt; None</span>
</span><span id="1-62">        <span class="k">if</span> <span class="n">transaction_style</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">TRANSACTION_STYLE_VALUES</span><span class="p">:</span>
</span><span id="1-63">            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="1-64">                <span class="s2">&quot;Invalid value for transaction_style: </span><span class="si">%s</span><span class="s2"> (must be in </span><span class="si">%s</span><span class="s2">)&quot;</span>
</span><span id="1-65">                <span class="o">%</span> <span class="p">(</span><span class="n">transaction_style</span><span class="p">,</span> <span class="n">TRANSACTION_STYLE_VALUES</span><span class="p">)</span>
</span><span id="1-66">            <span class="p">)</span>
</span><span id="1-67">        <span class="bp">self</span><span class="o">.</span><span class="n">transaction_style</span> <span class="o">=</span> <span class="n">transaction_style</span>
</span><span id="1-68">
</span><span id="1-69">    <span class="nd">@staticmethod</span>
</span><span id="1-70">    <span class="k">def</span> <span class="nf">setup_once</span><span class="p">():</span>
</span><span id="1-71">        <span class="c1"># type: () -&gt; None</span>
</span><span id="1-72">
</span><span id="1-73">        <span class="n">installed_packages</span> <span class="o">=</span> <span class="n">_get_installed_modules</span><span class="p">()</span>
</span><span id="1-74">        <span class="n">flask_version</span> <span class="o">=</span> <span class="n">installed_packages</span><span class="p">[</span><span class="s2">&quot;flask&quot;</span><span class="p">]</span>
</span><span id="1-75">        <span class="n">version</span> <span class="o">=</span> <span class="n">parse_version</span><span class="p">(</span><span class="n">flask_version</span><span class="p">)</span>
</span><span id="1-76">
</span><span id="1-77">        <span class="k">if</span> <span class="n">version</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-78">            <span class="k">raise</span> <span class="n">DidNotEnable</span><span class="p">(</span><span class="s2">&quot;Unparsable Flask version: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flask_version</span><span class="p">))</span>
</span><span id="1-79">
</span><span id="1-80">        <span class="k">if</span> <span class="n">version</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>
</span><span id="1-81">            <span class="k">raise</span> <span class="n">DidNotEnable</span><span class="p">(</span><span class="s2">&quot;Flask 0.10 or newer is required.&quot;</span><span class="p">)</span>
</span><span id="1-82">
</span><span id="1-83">        <span class="n">before_render_template</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">_add_sentry_trace</span><span class="p">)</span>
</span><span id="1-84">        <span class="n">request_started</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">_request_started</span><span class="p">)</span>
</span><span id="1-85">        <span class="n">got_request_exception</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">_capture_exception</span><span class="p">)</span>
</span><span id="1-86">
</span><span id="1-87">        <span class="n">old_app</span> <span class="o">=</span> <span class="n">Flask</span><span class="o">.</span><span class="fm">__call__</span>
</span><span id="1-88">
</span><span id="1-89">        <span class="k">def</span> <span class="nf">sentry_patched_wsgi_app</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
</span><span id="1-90">            <span class="c1"># type: (Any, Dict[str, str], Callable[..., Any]) -&gt; _ScopedResponse</span>
</span><span id="1-91">            <span class="k">if</span> <span class="n">Hub</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">get_integration</span><span class="p">(</span><span class="n">FlaskIntegration</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-92">                <span class="k">return</span> <span class="n">old_app</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
</span><span id="1-93">
</span><span id="1-94">            <span class="k">return</span> <span class="n">SentryWsgiMiddleware</span><span class="p">(</span><span class="k">lambda</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">old_app</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">))(</span>
</span><span id="1-95">                <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span>
</span><span id="1-96">            <span class="p">)</span>
</span><span id="1-97">
</span><span id="1-98">        <span class="n">Flask</span><span class="o">.</span><span class="fm">__call__</span> <span class="o">=</span> <span class="n">sentry_patched_wsgi_app</span></div>

</span><span id="1-99">
</span><span id="1-100">
</span><span id="1-101"><span class="k">def</span> <span class="nf">_add_sentry_trace</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="o">**</span><span class="n">extra</span><span class="p">):</span>
</span><span id="1-102">    <span class="c1"># type: (Flask, Any, Dict[str, Any], **Any) -&gt; None</span>
</span><span id="1-103">    <span class="k">if</span> <span class="s2">&quot;sentry_trace&quot;</span> <span class="ow">in</span> <span class="n">context</span><span class="p">:</span>
</span><span id="1-104">        <span class="k">return</span>
</span><span id="1-105">
</span><span id="1-106">    <span class="n">hub</span> <span class="o">=</span> <span class="n">Hub</span><span class="o">.</span><span class="n">current</span>
</span><span id="1-107">    <span class="n">trace_meta</span> <span class="o">=</span> <span class="n">Markup</span><span class="p">(</span><span class="n">hub</span><span class="o">.</span><span class="n">trace_propagation_meta</span><span class="p">())</span>
</span><span id="1-108">    <span class="n">context</span><span class="p">[</span><span class="s2">&quot;sentry_trace&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">trace_meta</span>  <span class="c1"># for backwards compatibility</span>
</span><span id="1-109">    <span class="n">context</span><span class="p">[</span><span class="s2">&quot;sentry_trace_meta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">trace_meta</span>
</span><span id="1-110">
</span><span id="1-111">
</span><span id="1-112"><span class="k">def</span> <span class="nf">_set_transaction_name_and_source</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">transaction_style</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span><span id="1-113">    <span class="c1"># type: (Scope, str, Request) -&gt; None</span>
</span><span id="1-114">    <span class="k">try</span><span class="p">:</span>
</span><span id="1-115">        <span class="n">name_for_style</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="1-116">            <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">url_rule</span><span class="o">.</span><span class="n">rule</span><span class="p">,</span>
</span><span id="1-117">            <span class="s2">&quot;endpoint&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">url_rule</span><span class="o">.</span><span class="n">endpoint</span><span class="p">,</span>
</span><span id="1-118">        <span class="p">}</span>
</span><span id="1-119">        <span class="n">scope</span><span class="o">.</span><span class="n">set_transaction_name</span><span class="p">(</span>
</span><span id="1-120">            <span class="n">name_for_style</span><span class="p">[</span><span class="n">transaction_style</span><span class="p">],</span>
</span><span id="1-121">            <span class="n">source</span><span class="o">=</span><span class="n">SOURCE_FOR_STYLE</span><span class="p">[</span><span class="n">transaction_style</span><span class="p">],</span>
</span><span id="1-122">        <span class="p">)</span>
</span><span id="1-123">    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="1-124">        <span class="k">pass</span>
</span><span id="1-125">
</span><span id="1-126">
</span><span id="1-127"><span class="k">def</span> <span class="nf">_request_started</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="1-128">    <span class="c1"># type: (Flask, **Any) -&gt; None</span>
</span><span id="1-129">    <span class="n">hub</span> <span class="o">=</span> <span class="n">Hub</span><span class="o">.</span><span class="n">current</span>
</span><span id="1-130">    <span class="n">integration</span> <span class="o">=</span> <span class="n">hub</span><span class="o">.</span><span class="n">get_integration</span><span class="p">(</span><span class="n">FlaskIntegration</span><span class="p">)</span>
</span><span id="1-131">    <span class="k">if</span> <span class="n">integration</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-132">        <span class="k">return</span>
</span><span id="1-133">
</span><span id="1-134">    <span class="k">with</span> <span class="n">hub</span><span class="o">.</span><span class="n">configure_scope</span><span class="p">()</span> <span class="k">as</span> <span class="n">scope</span><span class="p">:</span>
</span><span id="1-135">        <span class="c1"># Set the transaction name and source here,</span>
</span><span id="1-136">        <span class="c1"># but rely on WSGI middleware to actually start the transaction</span>
</span><span id="1-137">        <span class="n">request</span> <span class="o">=</span> <span class="n">flask_request</span><span class="o">.</span><span class="n">_get_current_object</span><span class="p">()</span>
</span><span id="1-138">        <span class="n">_set_transaction_name_and_source</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">integration</span><span class="o">.</span><span class="n">transaction_style</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
</span><span id="1-139">        <span class="n">evt_processor</span> <span class="o">=</span> <span class="n">_make_request_event_processor</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">integration</span><span class="p">)</span>
</span><span id="1-140">        <span class="n">scope</span><span class="o">.</span><span class="n">add_event_processor</span><span class="p">(</span><span class="n">evt_processor</span><span class="p">)</span>
</span><span id="1-141">
</span><span id="1-142">
</span><span id="1-143"><span class="k">class</span> <span class="nc">FlaskRequestExtractor</span><span class="p">(</span><span class="n">RequestExtractor</span><span class="p">):</span>
</span><span id="1-144">    <span class="k">def</span> <span class="nf">env</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="1-145">        <span class="c1"># type: () -&gt; Dict[str, str]</span>
</span><span id="1-146">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">environ</span>
</span><span id="1-147">
</span><span id="1-148">    <span class="k">def</span> <span class="nf">cookies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="1-149">        <span class="c1"># type: () -&gt; Dict[Any, Any]</span>
</span><span id="1-150">        <span class="k">return</span> <span class="p">{</span>
</span><span id="1-151">            <span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">v</span>
</span><span id="1-152">            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="1-153">        <span class="p">}</span>
</span><span id="1-154">
</span><span id="1-155">    <span class="k">def</span> <span class="nf">raw_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="1-156">        <span class="c1"># type: () -&gt; bytes</span>
</span><span id="1-157">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
</span><span id="1-158">
</span><span id="1-159">    <span class="k">def</span> <span class="nf">form</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="1-160">        <span class="c1"># type: () -&gt; ImmutableMultiDict[str, Any]</span>
</span><span id="1-161">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">form</span>
</span><span id="1-162">
</span><span id="1-163">    <span class="k">def</span> <span class="nf">files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="1-164">        <span class="c1"># type: () -&gt; ImmutableMultiDict[str, Any]</span>
</span><span id="1-165">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">files</span>
</span><span id="1-166">
</span><span id="1-167">    <span class="k">def</span> <span class="nf">is_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="1-168">        <span class="c1"># type: () -&gt; bool</span>
</span><span id="1-169">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">is_json</span>
</span><span id="1-170">
</span><span id="1-171">    <span class="k">def</span> <span class="nf">json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="1-172">        <span class="c1"># type: () -&gt; Any</span>
</span><span id="1-173">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">(</span><span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="1-174">
</span><span id="1-175">    <span class="k">def</span> <span class="nf">size_of_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
</span><span id="1-176">        <span class="c1"># type: (FileStorage) -&gt; int</span>
</span><span id="1-177">        <span class="k">return</span> <span class="n">file</span><span class="o">.</span><span class="n">content_length</span>
</span><span id="1-178">
</span><span id="1-179">
</span><span id="1-180"><span class="k">def</span> <span class="nf">_make_request_event_processor</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">integration</span><span class="p">):</span>
</span><span id="1-181">    <span class="c1"># type: (Flask, Callable[[], Request], FlaskIntegration) -&gt; EventProcessor</span>
</span><span id="1-182">
</span><span id="1-183">    <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">hint</span><span class="p">):</span>
</span><span id="1-184">        <span class="c1"># type: (Dict[str, Any], Dict[str, Any]) -&gt; Dict[str, Any]</span>
</span><span id="1-185">
</span><span id="1-186">        <span class="c1"># if the request is gone we are fine not logging the data from</span>
</span><span id="1-187">        <span class="c1"># it.  This might happen if the processor is pushed away to</span>
</span><span id="1-188">        <span class="c1"># another thread.</span>
</span><span id="1-189">        <span class="k">if</span> <span class="n">request</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-190">            <span class="k">return</span> <span class="n">event</span>
</span><span id="1-191">
</span><span id="1-192">        <span class="k">with</span> <span class="n">capture_internal_exceptions</span><span class="p">():</span>
</span><span id="1-193">            <span class="n">FlaskRequestExtractor</span><span class="p">(</span><span class="n">request</span><span class="p">)</span><span class="o">.</span><span class="n">extract_into_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</span><span id="1-194">
</span><span id="1-195">        <span class="k">if</span> <span class="n">_should_send_default_pii</span><span class="p">():</span>
</span><span id="1-196">            <span class="k">with</span> <span class="n">capture_internal_exceptions</span><span class="p">():</span>
</span><span id="1-197">                <span class="n">_add_user_to_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</span><span id="1-198">
</span><span id="1-199">        <span class="k">return</span> <span class="n">event</span>
</span><span id="1-200">
</span><span id="1-201">    <span class="k">return</span> <span class="n">inner</span>
</span><span id="1-202">
</span><span id="1-203">
</span><span id="1-204"><span class="k">def</span> <span class="nf">_capture_exception</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">exception</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="1-205">    <span class="c1"># type: (Flask, Union[ValueError, BaseException], **Any) -&gt; None</span>
</span><span id="1-206">    <span class="n">hub</span> <span class="o">=</span> <span class="n">Hub</span><span class="o">.</span><span class="n">current</span>
</span><span id="1-207">    <span class="k">if</span> <span class="n">hub</span><span class="o">.</span><span class="n">get_integration</span><span class="p">(</span><span class="n">FlaskIntegration</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-208">        <span class="k">return</span>
</span><span id="1-209">
</span><span id="1-210">    <span class="c1"># If an integration is there, a client has to be there.</span>
</span><span id="1-211">    <span class="n">client</span> <span class="o">=</span> <span class="n">hub</span><span class="o">.</span><span class="n">client</span>  <span class="c1"># type: Any</span>
</span><span id="1-212">
</span><span id="1-213">    <span class="n">event</span><span class="p">,</span> <span class="n">hint</span> <span class="o">=</span> <span class="n">event_from_exception</span><span class="p">(</span>
</span><span id="1-214">        <span class="n">exception</span><span class="p">,</span>
</span><span id="1-215">        <span class="n">client_options</span><span class="o">=</span><span class="n">client</span><span class="o">.</span><span class="n">options</span><span class="p">,</span>
</span><span id="1-216">        <span class="n">mechanism</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;flask&quot;</span><span class="p">,</span> <span class="s2">&quot;handled&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
</span><span id="1-217">    <span class="p">)</span>
</span><span id="1-218">
</span><span id="1-219">    <span class="n">hub</span><span class="o">.</span><span class="n">capture_event</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">hint</span><span class="o">=</span><span class="n">hint</span><span class="p">)</span>
</span><span id="1-220">
</span><span id="1-221">
</span><span id="1-222"><span class="k">def</span> <span class="nf">_add_user_to_event</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
</span><span id="1-223">    <span class="c1"># type: (Dict[str, Any]) -&gt; None</span>
</span><span id="1-224">    <span class="k">if</span> <span class="n">flask_login</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-225">        <span class="k">return</span>
</span><span id="1-226">
</span><span id="1-227">    <span class="n">user</span> <span class="o">=</span> <span class="n">flask_login</span><span class="o">.</span><span class="n">current_user</span>
</span><span id="1-228">    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-229">        <span class="k">return</span>
</span><span id="1-230">
</span><span id="1-231">    <span class="k">with</span> <span class="n">capture_internal_exceptions</span><span class="p">():</span>
</span><span id="1-232">        <span class="c1"># Access this object as late as possible as accessing the user</span>
</span><span id="1-233">        <span class="c1"># is relatively costly</span>
</span><span id="1-234">
</span><span id="1-235">        <span class="n">user_info</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="1-236">
</span><span id="1-237">        <span class="k">try</span><span class="p">:</span>
</span><span id="1-238">            <span class="n">user_info</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">get_id</span><span class="p">())</span>
</span><span id="1-239">            <span class="c1"># TODO: more configurable user attrs here</span>
</span><span id="1-240">        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
</span><span id="1-241">            <span class="c1"># might happen if:</span>
</span><span id="1-242">            <span class="c1"># - flask_login could not be imported</span>
</span><span id="1-243">            <span class="c1"># - flask_login is not configured</span>
</span><span id="1-244">            <span class="c1"># - no user is logged in</span>
</span><span id="1-245">            <span class="k">pass</span>
</span><span id="1-246">
</span><span id="1-247">        <span class="c1"># The following attribute accesses are ineffective for the general</span>
</span><span id="1-248">        <span class="c1"># Flask-Login case, because the User interface of Flask-Login does not</span>
</span><span id="1-249">        <span class="c1"># care about anything but the ID. However, Flask-User (based on</span>
</span><span id="1-250">        <span class="c1"># Flask-Login) documents a few optional extra attributes.</span>
</span><span id="1-251">        <span class="c1">#</span>
</span><span id="1-252">        <span class="c1"># https://github.com/lingthio/Flask-User/blob/a379fa0a281789618c484b459cb41236779b95b1/docs/source/data_models.rst#fixed-data-model-property-names</span>
</span><span id="1-253">
</span><span id="1-254">        <span class="k">try</span><span class="p">:</span>
</span><span id="1-255">            <span class="n">user_info</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;email&quot;</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
</span><span id="1-256">        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="1-257">            <span class="k">pass</span>
</span><span id="1-258">
</span><span id="1-259">        <span class="k">try</span><span class="p">:</span>
</span><span id="1-260">            <span class="n">user_info</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
</span><span id="1-261">        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="1-262">            <span class="k">pass</span>
</span></pre></div>
        </article>
        
        <div class="navigation flex print:hidden">
  
  
</div>
        
      </div>
    </div>
  </main>
</div>
<footer class="sy-foot">
  <div class="sy-foot-inner sy-container mx-auto">
    
    <div class="sy-foot-reserved md:flex justify-between items-center">
      <div class="sy-foot-copyright"><p>2019-2023, Sentry Team and Contributors</p>
        
        <p>
          Made with
          
          <a href="https://www.sphinx-doc.org/">Sphinx</a> and
          
          <a href="https://shibuya.lepture.com">Shibuya theme</a>.
        </p>
      </div>
      <div class="sy-foot-socials">
          <a href="https://github.com/getsentry/sentry-python" aria-label="GitHub"><i class="i-icon github"></i></a>
      </div>
    </div>
  </div>
</footer></div>
      <script src="../../../_static/documentation_options.js?v=497d83b4"></script>
      <script src="../../../_static/doctools.js?v=888ff710"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../_static/shibuya.js?v=3e5c8598"></script>
    
</body>
</html>