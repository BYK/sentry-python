
  <!DOCTYPE html>
<html lang="en" data-accent-color="violet" data-content_root="../../">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>sentry_sdk.transport - sentry-python 1.42.0 documentation</title>
    <link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" />

  <script>
    function setColorMode(t){let e=document.documentElement;e.setAttribute("data-color-mode",t);let a=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,s=t;"auto"===t&&(s=a?"dark":"light"),"light"===s?(e.classList.remove("dark"),e.classList.add("light")):(e.classList.remove("light"),e.classList.add("dark"))}
    setColorMode(sessionStorage._theme||"auto");
  </script><link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=aecf457f" />
    <link rel="stylesheet" type="text/css" href="../../_static/shibuya.css?v=d42a0c83" />
    <link media="print" rel="stylesheet" type="text/css" href="../../_static/print.css?v=20ff2c19" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --sy-f-text: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
  --sy-f-heading: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
}
</style>
    <meta property="og:type" content="website"/><meta property="og:title" content="sentry_sdk.transport"/>
<meta name="twitter:card" content="summary"/>
  </head>
<body><div class="document"><div class="sy-head">
  <div class="sy-head-blur"></div>
  <div class="sy-head-inner sy-container mx-auto">
    <a class="sy-head-brand mr-4" href="../../index.html">
      
      
      <strong>sentry-python</strong>
    </a>
    <div class="sy-head-links" id="NavLinks">
      <nav class="sy-head-nav"></nav>
      <div class="sy-head-extra flex items-center print:hidden">
<form class="searchbox flex items-center" action="../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <kbd>/</kbd>
</form>
        
        
        <div class="sy-head-social flex items-center">
            <a class="flex items-center" href="https://github.com/getsentry/sentry-python" aria-label="GitHub">
              <i class="i-icon github"></i>
            </a>
        </div>
      </div>
    </div>
    <div class="sy-head-actions flex items-center shrink-0 print:hidden">
      <button class="js-theme theme-switch flex items-center"
        data-aria-auto="Switch to light color mode"
        data-aria-light="Switch to dark color mode"
        data-aria-dark="Switch to auto color mode">
        <i class="i-icon theme-icon"></i>
      </button>
      <button class="md:hidden flex items-center js-menu" aria-label="Menu" type="button" aria-controls="NavLinks" aria-expanded="false">
        <div class="hamburger">
          <span class="hamburger_1"></span>
          <span class="hamburger_2 -translate-x-2"></span>
          <span class="hamburger_3 -translate-x-1"></span>
        </div>
      </button>
    </div>
  </div>
</div>
<div class="sy-page sy-container flex mx-auto">
  <aside id="lside" class="sy-lside md:w-72 md:shrink-0 print:hidden">
    <div class="sy-lside-inner md:sticky">
      <div class="sy-scrollbar p-6">
        <div class="globaltoc" data-expand-depth="0"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">Top Level API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../integrations.html">Integrations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../apidocs.html">API Docs</a></li>
</ul>

        </div>
      </div>
      
    </div>
  </aside>
  <div class="lside-overlay js-menu" role="button" aria-label="Close left sidebar" aria-controls="lside" aria-expanded="false"></div>
  <aside id="rside" class="sy-rside pb-3 w-64 shrink-0 order-last">
    <button class="rside-close js-menu xl:hidden" aria-label="Close Table of Contents" type="button" aria-controls="rside" aria-expanded="false">
      <i class="i-icon close"></i>
    </button>
    <div class="sy-scrollbar sy-rside-inner px-6 xl:top-16 xl:sticky xl:pl-0 pt-6 pb-4"><div id="ethical-ad-placement" data-ea-publisher="readthedocs"></div>
    </div>
  </aside>
  <div class="rside-overlay js-menu" role="button" aria-label="Close Table of Contents" aria-controls="rside" aria-expanded="false"></div>
  <main class="sy-main w-full max-sm:max-w-full print:pt-6">
    <div class="sy-breadcrumbs" role="navigation">
  <div class="sy-breadcrumbs-inner flex items-center">
    <div class="md:hidden mr-3">
      <button class="js-menu" aria-label="Menu" type="button" aria-controls="lside" aria-expanded="false">
        <i class="i-icon menu"></i>
      </button>
    </div>
    <ol class="flex-1" itemscope itemtype="https://schema.org/BreadcrumbList">
      
      
      <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../../index.html"><span itemprop="name">sentry-python</span></a>
        <span>/</span>
        <meta itemprop="position" content="1" />
      </li>
      
      <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../index.html"><span itemprop="name">Module code</span></a>
        <span>/</span>
        <meta itemprop="position" content="2" />
      </li>
      
      <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <strong itemprop="name">sentry_sdk.transport</strong>
        <meta itemprop="position" content="3" />
      </li>
      
      
    </ol>
    <div class="xl:hidden ml-1">
      <button class="js-menu" aria-label="Show table of contents" type="button" aria-controls="rside"
        aria-expanded="false">
        <i class="i-icon outdent"></i>
      </button>
    </div>
  </div>
</div>
    <div class="flex flex-col break-words justify-between">
      <div class="min-w-0 max-w-6xl px-6 pb-6 pt-8 xl:px-12">
        <article class="yue" role="main">
          <h1>Source code for sentry_sdk.transport</h1><div class="highlight"><pre>
<span></span><span id="1-1"><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
</span><span id="1-2">
</span><span id="1-3"><span class="kn">import</span> <span class="nn">io</span>
</span><span id="1-4"><span class="kn">import</span> <span class="nn">gzip</span>
</span><span id="1-5"><span class="kn">import</span> <span class="nn">time</span>
</span><span id="1-6"><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">timedelta</span>
</span><span id="1-7"><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
</span><span id="1-8">
</span><span id="1-9"><span class="kn">import</span> <span class="nn">urllib3</span>
</span><span id="1-10"><span class="kn">import</span> <span class="nn">certifi</span>
</span><span id="1-11">
</span><span id="1-12"><span class="kn">from</span> <span class="nn">sentry_sdk.utils</span> <span class="kn">import</span> <span class="n">Dsn</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">capture_internal_exceptions</span><span class="p">,</span> <span class="n">json_dumps</span>
</span><span id="1-13"><span class="kn">from</span> <span class="nn">sentry_sdk.worker</span> <span class="kn">import</span> <span class="n">BackgroundWorker</span>
</span><span id="1-14"><span class="kn">from</span> <span class="nn">sentry_sdk.envelope</span> <span class="kn">import</span> <span class="n">Envelope</span><span class="p">,</span> <span class="n">Item</span><span class="p">,</span> <span class="n">PayloadRef</span>
</span><span id="1-15"><span class="kn">from</span> <span class="nn">sentry_sdk._compat</span> <span class="kn">import</span> <span class="n">datetime_utcnow</span>
</span><span id="1-16"><span class="kn">from</span> <span class="nn">sentry_sdk._types</span> <span class="kn">import</span> <span class="n">TYPE_CHECKING</span>
</span><span id="1-17">
</span><span id="1-18"><span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span id="1-19">    <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
</span><span id="1-20">    <span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>
</span><span id="1-21">    <span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span>
</span><span id="1-22">    <span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span>
</span><span id="1-23">    <span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Iterable</span>
</span><span id="1-24">    <span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>
</span><span id="1-25">    <span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span>
</span><span id="1-26">    <span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Type</span>
</span><span id="1-27">    <span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span>
</span><span id="1-28">    <span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">DefaultDict</span>
</span><span id="1-29">
</span><span id="1-30">    <span class="kn">from</span> <span class="nn">urllib3.poolmanager</span> <span class="kn">import</span> <span class="n">PoolManager</span>
</span><span id="1-31">    <span class="kn">from</span> <span class="nn">urllib3.poolmanager</span> <span class="kn">import</span> <span class="n">ProxyManager</span>
</span><span id="1-32">
</span><span id="1-33">    <span class="kn">from</span> <span class="nn">sentry_sdk._types</span> <span class="kn">import</span> <span class="n">Event</span><span class="p">,</span> <span class="n">EndpointType</span>
</span><span id="1-34">
</span><span id="1-35">    <span class="n">DataCategory</span> <span class="o">=</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span><span id="1-36">
</span><span id="1-37"><span class="k">try</span><span class="p">:</span>
</span><span id="1-38">    <span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">getproxies</span>
</span><span id="1-39"><span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
</span><span id="1-40">    <span class="kn">from</span> <span class="nn">urllib</span> <span class="kn">import</span> <span class="n">getproxies</span>  <span class="c1"># type: ignore</span>
</span><span id="1-41">
</span><span id="1-42">
<div class="viewcode-block" id="Transport">
<a class="viewcode-back" href="../../apidocs.html#sentry_sdk.Transport">[docs]</a>
</span><span id="1-43"><span class="k">class</span> <span class="nc">Transport</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span id="1-44"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Baseclass for all transports.</span>
</span><span id="1-45">
</span><span id="1-46"><span class="sd">    A transport is used to send an event to sentry.</span>
</span><span id="1-47"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-48">
</span><span id="1-49">    <span class="n">parsed_dsn</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Optional[Dsn]</span>
</span><span id="1-50">
</span><span id="1-51">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="1-52">        <span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span>  <span class="c1"># type: Optional[Dict[str, Any]]</span>
</span><span id="1-53">    <span class="p">):</span>
</span><span id="1-54">        <span class="c1"># type: (...) -&gt; None</span>
</span><span id="1-55">        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span>
</span><span id="1-56">        <span class="k">if</span> <span class="n">options</span> <span class="ow">and</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;dsn&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;dsn&quot;</span><span class="p">]:</span>
</span><span id="1-57">            <span class="bp">self</span><span class="o">.</span><span class="n">parsed_dsn</span> <span class="o">=</span> <span class="n">Dsn</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;dsn&quot;</span><span class="p">])</span>
</span><span id="1-58">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-59">            <span class="bp">self</span><span class="o">.</span><span class="n">parsed_dsn</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="1-60">
<div class="viewcode-block" id="Transport.capture_event">
<a class="viewcode-back" href="../../apidocs.html#sentry_sdk.Transport.capture_event">[docs]</a>
</span><span id="1-61">    <span class="k">def</span> <span class="nf">capture_event</span><span class="p">(</span>
</span><span id="1-62">        <span class="bp">self</span><span class="p">,</span> <span class="n">event</span>  <span class="c1"># type: Event</span>
</span><span id="1-63">    <span class="p">):</span>
</span><span id="1-64">        <span class="c1"># type: (...) -&gt; None</span>
</span><span id="1-65"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="1-66"><span class="sd">        This gets invoked with the event dictionary when an event should</span>
</span><span id="1-67"><span class="sd">        be sent to sentry.</span>
</span><span id="1-68"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-69">        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

</span><span id="1-70">
<div class="viewcode-block" id="Transport.capture_envelope">
<a class="viewcode-back" href="../../apidocs.html#sentry_sdk.Transport.capture_envelope">[docs]</a>
</span><span id="1-71">    <span class="k">def</span> <span class="nf">capture_envelope</span><span class="p">(</span>
</span><span id="1-72">        <span class="bp">self</span><span class="p">,</span> <span class="n">envelope</span>  <span class="c1"># type: Envelope</span>
</span><span id="1-73">    <span class="p">):</span>
</span><span id="1-74">        <span class="c1"># type: (...) -&gt; None</span>
</span><span id="1-75"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="1-76"><span class="sd">        Send an envelope to Sentry.</span>
</span><span id="1-77">
</span><span id="1-78"><span class="sd">        Envelopes are a data container format that can hold any type of data</span>
</span><span id="1-79"><span class="sd">        submitted to Sentry. We use it for transactions and sessions, but</span>
</span><span id="1-80"><span class="sd">        regular &quot;error&quot; events should go through `capture_event` for backwards</span>
</span><span id="1-81"><span class="sd">        compat.</span>
</span><span id="1-82"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-83">        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

</span><span id="1-84">
<div class="viewcode-block" id="Transport.flush">
<a class="viewcode-back" href="../../apidocs.html#sentry_sdk.Transport.flush">[docs]</a>
</span><span id="1-85">    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span>
</span><span id="1-86">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-87">        <span class="n">timeout</span><span class="p">,</span>  <span class="c1"># type: float</span>
</span><span id="1-88">        <span class="n">callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># type: Optional[Any]</span>
</span><span id="1-89">    <span class="p">):</span>
</span><span id="1-90">        <span class="c1"># type: (...) -&gt; None</span>
</span><span id="1-91"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Wait `timeout` seconds for the current events to be sent out.&quot;&quot;&quot;</span>
</span><span id="1-92">        <span class="k">pass</span></div>

</span><span id="1-93">
<div class="viewcode-block" id="Transport.kill">
<a class="viewcode-back" href="../../apidocs.html#sentry_sdk.Transport.kill">[docs]</a>
</span><span id="1-94">    <span class="k">def</span> <span class="nf">kill</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="1-95">        <span class="c1"># type: () -&gt; None</span>
</span><span id="1-96"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Forcefully kills the transport.&quot;&quot;&quot;</span>
</span><span id="1-97">        <span class="k">pass</span></div>

</span><span id="1-98">
<div class="viewcode-block" id="Transport.record_lost_event">
<a class="viewcode-back" href="../../apidocs.html#sentry_sdk.Transport.record_lost_event">[docs]</a>
</span><span id="1-99">    <span class="k">def</span> <span class="nf">record_lost_event</span><span class="p">(</span>
</span><span id="1-100">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-101">        <span class="n">reason</span><span class="p">,</span>  <span class="c1"># type: str</span>
</span><span id="1-102">        <span class="n">data_category</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># type: Optional[str]</span>
</span><span id="1-103">        <span class="n">item</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># type: Optional[Item]</span>
</span><span id="1-104">    <span class="p">):</span>
</span><span id="1-105">        <span class="c1"># type: (...) -&gt; None</span>
</span><span id="1-106"><span class="w">        </span><span class="sd">&quot;&quot;&quot;This increments a counter for event loss by reason and</span>
</span><span id="1-107"><span class="sd">        data category.</span>
</span><span id="1-108"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-109">        <span class="k">return</span> <span class="kc">None</span></div>

</span><span id="1-110">
</span><span id="1-111">    <span class="k">def</span> <span class="nf">is_healthy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="1-112">        <span class="c1"># type: () -&gt; bool</span>
</span><span id="1-113">        <span class="k">return</span> <span class="kc">True</span>
</span><span id="1-114">
</span><span id="1-115">    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="1-116">        <span class="c1"># type: () -&gt; None</span>
</span><span id="1-117">        <span class="k">try</span><span class="p">:</span>
</span><span id="1-118">            <span class="bp">self</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
</span><span id="1-119">        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="1-120">            <span class="k">pass</span></div>

</span><span id="1-121">
</span><span id="1-122">
</span><span id="1-123"><span class="k">def</span> <span class="nf">_parse_rate_limits</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">now</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="1-124">    <span class="c1"># type: (Any, Optional[datetime]) -&gt; Iterable[Tuple[DataCategory, datetime]]</span>
</span><span id="1-125">    <span class="k">if</span> <span class="n">now</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-126">        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime_utcnow</span><span class="p">()</span>
</span><span id="1-127">
</span><span id="1-128">    <span class="k">for</span> <span class="n">limit</span> <span class="ow">in</span> <span class="n">header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">):</span>
</span><span id="1-129">        <span class="k">try</span><span class="p">:</span>
</span><span id="1-130">            <span class="n">retry_after</span><span class="p">,</span> <span class="n">categories</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">limit</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="1-131">            <span class="n">retry_after</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">retry_after</span><span class="p">))</span>
</span><span id="1-132">            <span class="k">for</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">categories</span> <span class="ow">and</span> <span class="n">categories</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="kc">None</span><span class="p">,):</span>
</span><span id="1-133">                <span class="k">yield</span> <span class="n">category</span><span class="p">,</span> <span class="n">retry_after</span>
</span><span id="1-134">        <span class="k">except</span> <span class="p">(</span><span class="ne">LookupError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
</span><span id="1-135">            <span class="k">continue</span>
</span><span id="1-136">
</span><span id="1-137">
<div class="viewcode-block" id="HttpTransport">
<a class="viewcode-back" href="../../apidocs.html#sentry_sdk.HttpTransport">[docs]</a>
</span><span id="1-138"><span class="k">class</span> <span class="nc">HttpTransport</span><span class="p">(</span><span class="n">Transport</span><span class="p">):</span>
</span><span id="1-139"><span class="w">    </span><span class="sd">&quot;&quot;&quot;The default HTTP transport.&quot;&quot;&quot;</span>
</span><span id="1-140">
</span><span id="1-141">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="1-142">        <span class="bp">self</span><span class="p">,</span> <span class="n">options</span>  <span class="c1"># type: Dict[str, Any]</span>
</span><span id="1-143">    <span class="p">):</span>
</span><span id="1-144">        <span class="c1"># type: (...) -&gt; None</span>
</span><span id="1-145">        <span class="kn">from</span> <span class="nn">sentry_sdk.consts</span> <span class="kn">import</span> <span class="n">VERSION</span>
</span><span id="1-146">
</span><span id="1-147">        <span class="n">Transport</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span><span id="1-148">        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">parsed_dsn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="1-149">        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span>  <span class="c1"># type: Dict[str, Any]</span>
</span><span id="1-150">        <span class="bp">self</span><span class="o">.</span><span class="n">_worker</span> <span class="o">=</span> <span class="n">BackgroundWorker</span><span class="p">(</span><span class="n">queue_size</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;transport_queue_size&quot;</span><span class="p">])</span>
</span><span id="1-151">        <span class="bp">self</span><span class="o">.</span><span class="n">_auth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parsed_dsn</span><span class="o">.</span><span class="n">to_auth</span><span class="p">(</span><span class="s2">&quot;sentry.python/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">VERSION</span><span class="p">)</span>
</span><span id="1-152">        <span class="bp">self</span><span class="o">.</span><span class="n">_disabled_until</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># type: Dict[DataCategory, datetime]</span>
</span><span id="1-153">        <span class="bp">self</span><span class="o">.</span><span class="n">_retry</span> <span class="o">=</span> <span class="n">urllib3</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">Retry</span><span class="p">()</span>
</span><span id="1-154">        <span class="bp">self</span><span class="o">.</span><span class="n">_discarded_events</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span>
</span><span id="1-155">            <span class="nb">int</span>
</span><span id="1-156">        <span class="p">)</span>  <span class="c1"># type: DefaultDict[Tuple[str, str], int]</span>
</span><span id="1-157">        <span class="bp">self</span><span class="o">.</span><span class="n">_last_client_report_sent</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="1-158">
</span><span id="1-159">        <span class="n">compresslevel</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_experiments&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span id="1-160">            <span class="s2">&quot;transport_zlib_compression_level&quot;</span>
</span><span id="1-161">        <span class="p">)</span>
</span><span id="1-162">        <span class="bp">self</span><span class="o">.</span><span class="n">_compresslevel</span> <span class="o">=</span> <span class="mi">9</span> <span class="k">if</span> <span class="n">compresslevel</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">compresslevel</span><span class="p">)</span>
</span><span id="1-163">
</span><span id="1-164">        <span class="n">num_pools</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_experiments&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;transport_num_pools&quot;</span><span class="p">)</span>
</span><span id="1-165">        <span class="bp">self</span><span class="o">.</span><span class="n">_num_pools</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">num_pools</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_pools</span><span class="p">)</span>
</span><span id="1-166">
</span><span id="1-167">        <span class="bp">self</span><span class="o">.</span><span class="n">_pool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_pool</span><span class="p">(</span>
</span><span id="1-168">            <span class="bp">self</span><span class="o">.</span><span class="n">parsed_dsn</span><span class="p">,</span>
</span><span id="1-169">            <span class="n">http_proxy</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;http_proxy&quot;</span><span class="p">],</span>
</span><span id="1-170">            <span class="n">https_proxy</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;https_proxy&quot;</span><span class="p">],</span>
</span><span id="1-171">            <span class="n">ca_certs</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;ca_certs&quot;</span><span class="p">],</span>
</span><span id="1-172">            <span class="n">proxy_headers</span><span class="o">=</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;proxy_headers&quot;</span><span class="p">],</span>
</span><span id="1-173">        <span class="p">)</span>
</span><span id="1-174">
</span><span id="1-175">        <span class="kn">from</span> <span class="nn">sentry_sdk</span> <span class="kn">import</span> <span class="n">Hub</span>
</span><span id="1-176">
</span><span id="1-177">        <span class="bp">self</span><span class="o">.</span><span class="n">hub_cls</span> <span class="o">=</span> <span class="n">Hub</span>
</span><span id="1-178">
<div class="viewcode-block" id="HttpTransport.record_lost_event">
<a class="viewcode-back" href="../../apidocs.html#sentry_sdk.HttpTransport.record_lost_event">[docs]</a>
</span><span id="1-179">    <span class="k">def</span> <span class="nf">record_lost_event</span><span class="p">(</span>
</span><span id="1-180">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-181">        <span class="n">reason</span><span class="p">,</span>  <span class="c1"># type: str</span>
</span><span id="1-182">        <span class="n">data_category</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># type: Optional[str]</span>
</span><span id="1-183">        <span class="n">item</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># type: Optional[Item]</span>
</span><span id="1-184">    <span class="p">):</span>
</span><span id="1-185">        <span class="c1"># type: (...) -&gt; None</span>
</span><span id="1-186">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;send_client_reports&quot;</span><span class="p">]:</span>
</span><span id="1-187">            <span class="k">return</span>
</span><span id="1-188">
</span><span id="1-189">        <span class="n">quantity</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="1-190">        <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-191">            <span class="n">data_category</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">data_category</span>
</span><span id="1-192">            <span class="k">if</span> <span class="n">data_category</span> <span class="o">==</span> <span class="s2">&quot;attachment&quot;</span><span class="p">:</span>
</span><span id="1-193">                <span class="c1"># quantity of 0 is actually 1 as we do not want to count</span>
</span><span id="1-194">                <span class="c1"># empty attachments as actually empty.</span>
</span><span id="1-195">                <span class="n">quantity</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">get_bytes</span><span class="p">())</span> <span class="ow">or</span> <span class="mi">1</span>
</span><span id="1-196">        <span class="k">elif</span> <span class="n">data_category</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-197">            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;data category not provided&quot;</span><span class="p">)</span>
</span><span id="1-198">
</span><span id="1-199">        <span class="bp">self</span><span class="o">.</span><span class="n">_discarded_events</span><span class="p">[</span><span class="n">data_category</span><span class="p">,</span> <span class="n">reason</span><span class="p">]</span> <span class="o">+=</span> <span class="n">quantity</span></div>

</span><span id="1-200">
</span><span id="1-201">    <span class="k">def</span> <span class="nf">_update_rate_limits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
</span><span id="1-202">        <span class="c1"># type: (urllib3.BaseHTTPResponse) -&gt; None</span>
</span><span id="1-203">
</span><span id="1-204">        <span class="c1"># new sentries with more rate limit insights.  We honor this header</span>
</span><span id="1-205">        <span class="c1"># no matter of the status code to update our internal rate limits.</span>
</span><span id="1-206">        <span class="n">header</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x-sentry-rate-limits&quot;</span><span class="p">)</span>
</span><span id="1-207">        <span class="k">if</span> <span class="n">header</span><span class="p">:</span>
</span><span id="1-208">            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Rate-limited via x-sentry-rate-limits&quot;</span><span class="p">)</span>
</span><span id="1-209">            <span class="bp">self</span><span class="o">.</span><span class="n">_disabled_until</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_parse_rate_limits</span><span class="p">(</span><span class="n">header</span><span class="p">))</span>
</span><span id="1-210">
</span><span id="1-211">        <span class="c1"># old sentries only communicate global rate limit hits via the</span>
</span><span id="1-212">        <span class="c1"># retry-after header on 429.  This header can also be emitted on new</span>
</span><span id="1-213">        <span class="c1"># sentries if a proxy in front wants to globally slow things down.</span>
</span><span id="1-214">        <span class="k">elif</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">429</span><span class="p">:</span>
</span><span id="1-215">            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Rate-limited via 429&quot;</span><span class="p">)</span>
</span><span id="1-216">            <span class="bp">self</span><span class="o">.</span><span class="n">_disabled_until</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime_utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span>
</span><span id="1-217">                <span class="n">seconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_retry</span><span class="o">.</span><span class="n">get_retry_after</span><span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">60</span>
</span><span id="1-218">            <span class="p">)</span>
</span><span id="1-219">
</span><span id="1-220">    <span class="k">def</span> <span class="nf">_send_request</span><span class="p">(</span>
</span><span id="1-221">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-222">        <span class="n">body</span><span class="p">,</span>  <span class="c1"># type: bytes</span>
</span><span id="1-223">        <span class="n">headers</span><span class="p">,</span>  <span class="c1"># type: Dict[str, str]</span>
</span><span id="1-224">        <span class="n">endpoint_type</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span>  <span class="c1"># type: EndpointType</span>
</span><span id="1-225">        <span class="n">envelope</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># type: Optional[Envelope]</span>
</span><span id="1-226">    <span class="p">):</span>
</span><span id="1-227">        <span class="c1"># type: (...) -&gt; None</span>
</span><span id="1-228">
</span><span id="1-229">        <span class="k">def</span> <span class="nf">record_loss</span><span class="p">(</span><span class="n">reason</span><span class="p">):</span>
</span><span id="1-230">            <span class="c1"># type: (str) -&gt; None</span>
</span><span id="1-231">            <span class="k">if</span> <span class="n">envelope</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-232">                <span class="bp">self</span><span class="o">.</span><span class="n">record_lost_event</span><span class="p">(</span><span class="n">reason</span><span class="p">,</span> <span class="n">data_category</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
</span><span id="1-233">            <span class="k">else</span><span class="p">:</span>
</span><span id="1-234">                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">envelope</span><span class="o">.</span><span class="n">items</span><span class="p">:</span>
</span><span id="1-235">                    <span class="bp">self</span><span class="o">.</span><span class="n">record_lost_event</span><span class="p">(</span><span class="n">reason</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span><span class="n">item</span><span class="p">)</span>
</span><span id="1-236">
</span><span id="1-237">        <span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
</span><span id="1-238">            <span class="p">{</span>
</span><span id="1-239">                <span class="s2">&quot;User-Agent&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_auth</span><span class="o">.</span><span class="n">client</span><span class="p">),</span>
</span><span id="1-240">                <span class="s2">&quot;X-Sentry-Auth&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_auth</span><span class="o">.</span><span class="n">to_header</span><span class="p">()),</span>
</span><span id="1-241">            <span class="p">}</span>
</span><span id="1-242">        <span class="p">)</span>
</span><span id="1-243">        <span class="k">try</span><span class="p">:</span>
</span><span id="1-244">            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pool</span><span class="o">.</span><span class="n">request</span><span class="p">(</span>
</span><span id="1-245">                <span class="s2">&quot;POST&quot;</span><span class="p">,</span>
</span><span id="1-246">                <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_auth</span><span class="o">.</span><span class="n">get_api_url</span><span class="p">(</span><span class="n">endpoint_type</span><span class="p">)),</span>
</span><span id="1-247">                <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">,</span>
</span><span id="1-248">                <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
</span><span id="1-249">            <span class="p">)</span>
</span><span id="1-250">        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="1-251">            <span class="bp">self</span><span class="o">.</span><span class="n">on_dropped_event</span><span class="p">(</span><span class="s2">&quot;network&quot;</span><span class="p">)</span>
</span><span id="1-252">            <span class="n">record_loss</span><span class="p">(</span><span class="s2">&quot;network_error&quot;</span><span class="p">)</span>
</span><span id="1-253">            <span class="k">raise</span>
</span><span id="1-254">
</span><span id="1-255">        <span class="k">try</span><span class="p">:</span>
</span><span id="1-256">            <span class="bp">self</span><span class="o">.</span><span class="n">_update_rate_limits</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span><span id="1-257">
</span><span id="1-258">            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">429</span><span class="p">:</span>
</span><span id="1-259">                <span class="c1"># if we hit a 429.  Something was rate limited but we already</span>
</span><span id="1-260">                <span class="c1"># acted on this in `self._update_rate_limits`.  Note that we</span>
</span><span id="1-261">                <span class="c1"># do not want to record event loss here as we will have recorded</span>
</span><span id="1-262">                <span class="c1"># an outcome in relay already.</span>
</span><span id="1-263">                <span class="bp">self</span><span class="o">.</span><span class="n">on_dropped_event</span><span class="p">(</span><span class="s2">&quot;status_429&quot;</span><span class="p">)</span>
</span><span id="1-264">                <span class="k">pass</span>
</span><span id="1-265">
</span><span id="1-266">            <span class="k">elif</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">&gt;=</span> <span class="mi">300</span> <span class="ow">or</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">200</span><span class="p">:</span>
</span><span id="1-267">                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
</span><span id="1-268">                    <span class="s2">&quot;Unexpected status code: </span><span class="si">%s</span><span class="s2"> (body: </span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span>
</span><span id="1-269">                    <span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
</span><span id="1-270">                    <span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
</span><span id="1-271">                <span class="p">)</span>
</span><span id="1-272">                <span class="bp">self</span><span class="o">.</span><span class="n">on_dropped_event</span><span class="p">(</span><span class="s2">&quot;status_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">))</span>
</span><span id="1-273">                <span class="n">record_loss</span><span class="p">(</span><span class="s2">&quot;network_error&quot;</span><span class="p">)</span>
</span><span id="1-274">        <span class="k">finally</span><span class="p">:</span>
</span><span id="1-275">            <span class="n">response</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="1-276">
</span><span id="1-277">    <span class="k">def</span> <span class="nf">on_dropped_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
</span><span id="1-278">        <span class="c1"># type: (str) -&gt; None</span>
</span><span id="1-279">        <span class="k">return</span> <span class="kc">None</span>
</span><span id="1-280">
</span><span id="1-281">    <span class="k">def</span> <span class="nf">_fetch_pending_client_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">60</span><span class="p">):</span>
</span><span id="1-282">        <span class="c1"># type: (bool, int) -&gt; Optional[Item]</span>
</span><span id="1-283">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;send_client_reports&quot;</span><span class="p">]:</span>
</span><span id="1-284">            <span class="k">return</span> <span class="kc">None</span>
</span><span id="1-285">
</span><span id="1-286">        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">force</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_client_report_sent</span> <span class="o">&lt;</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">interval</span><span class="p">):</span>
</span><span id="1-287">            <span class="k">return</span> <span class="kc">None</span>
</span><span id="1-288">
</span><span id="1-289">        <span class="n">discarded_events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_discarded_events</span>
</span><span id="1-290">        <span class="bp">self</span><span class="o">.</span><span class="n">_discarded_events</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</span><span id="1-291">        <span class="bp">self</span><span class="o">.</span><span class="n">_last_client_report_sent</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="1-292">
</span><span id="1-293">        <span class="k">if</span> <span class="ow">not</span> <span class="n">discarded_events</span><span class="p">:</span>
</span><span id="1-294">            <span class="k">return</span> <span class="kc">None</span>
</span><span id="1-295">
</span><span id="1-296">        <span class="k">return</span> <span class="n">Item</span><span class="p">(</span>
</span><span id="1-297">            <span class="n">PayloadRef</span><span class="p">(</span>
</span><span id="1-298">                <span class="n">json</span><span class="o">=</span><span class="p">{</span>
</span><span id="1-299">                    <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
</span><span id="1-300">                    <span class="s2">&quot;discarded_events&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="1-301">                        <span class="p">{</span><span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="n">reason</span><span class="p">,</span> <span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="n">category</span><span class="p">,</span> <span class="s2">&quot;quantity&quot;</span><span class="p">:</span> <span class="n">quantity</span><span class="p">}</span>
</span><span id="1-302">                        <span class="k">for</span> <span class="p">(</span>
</span><span id="1-303">                            <span class="p">(</span><span class="n">category</span><span class="p">,</span> <span class="n">reason</span><span class="p">),</span>
</span><span id="1-304">                            <span class="n">quantity</span><span class="p">,</span>
</span><span id="1-305">                        <span class="p">)</span> <span class="ow">in</span> <span class="n">discarded_events</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="1-306">                    <span class="p">],</span>
</span><span id="1-307">                <span class="p">}</span>
</span><span id="1-308">            <span class="p">),</span>
</span><span id="1-309">            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;client_report&quot;</span><span class="p">,</span>
</span><span id="1-310">        <span class="p">)</span>
</span><span id="1-311">
</span><span id="1-312">    <span class="k">def</span> <span class="nf">_flush_client_reports</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="1-313">        <span class="c1"># type: (bool) -&gt; None</span>
</span><span id="1-314">        <span class="n">client_report</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_pending_client_report</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
</span><span id="1-315">        <span class="k">if</span> <span class="n">client_report</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-316">            <span class="bp">self</span><span class="o">.</span><span class="n">capture_envelope</span><span class="p">(</span><span class="n">Envelope</span><span class="p">(</span><span class="n">items</span><span class="o">=</span><span class="p">[</span><span class="n">client_report</span><span class="p">]))</span>
</span><span id="1-317">
</span><span id="1-318">    <span class="k">def</span> <span class="nf">_check_disabled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">category</span><span class="p">):</span>
</span><span id="1-319">        <span class="c1"># type: (str) -&gt; bool</span>
</span><span id="1-320">        <span class="k">def</span> <span class="nf">_disabled</span><span class="p">(</span><span class="n">bucket</span><span class="p">):</span>
</span><span id="1-321">            <span class="c1"># type: (Any) -&gt; bool</span>
</span><span id="1-322">            <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_disabled_until</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span>
</span><span id="1-323">            <span class="k">return</span> <span class="n">ts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ts</span> <span class="o">&gt;</span> <span class="n">datetime_utcnow</span><span class="p">()</span>
</span><span id="1-324">
</span><span id="1-325">        <span class="k">return</span> <span class="n">_disabled</span><span class="p">(</span><span class="n">category</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_disabled</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</span><span id="1-326">
</span><span id="1-327">    <span class="k">def</span> <span class="nf">_is_rate_limited</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="1-328">        <span class="c1"># type: () -&gt; bool</span>
</span><span id="1-329">        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">ts</span> <span class="o">&gt;</span> <span class="n">datetime_utcnow</span><span class="p">()</span> <span class="k">for</span> <span class="n">ts</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_disabled_until</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span><span id="1-330">
</span><span id="1-331">    <span class="k">def</span> <span class="nf">_is_worker_full</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="1-332">        <span class="c1"># type: () -&gt; bool</span>
</span><span id="1-333">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_worker</span><span class="o">.</span><span class="n">full</span><span class="p">()</span>
</span><span id="1-334">
</span><span id="1-335">    <span class="k">def</span> <span class="nf">is_healthy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="1-336">        <span class="c1"># type: () -&gt; bool</span>
</span><span id="1-337">        <span class="k">return</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_is_worker_full</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_rate_limited</span><span class="p">())</span>
</span><span id="1-338">
</span><span id="1-339">    <span class="k">def</span> <span class="nf">_send_event</span><span class="p">(</span>
</span><span id="1-340">        <span class="bp">self</span><span class="p">,</span> <span class="n">event</span>  <span class="c1"># type: Event</span>
</span><span id="1-341">    <span class="p">):</span>
</span><span id="1-342">        <span class="c1"># type: (...) -&gt; None</span>
</span><span id="1-343">
</span><span id="1-344">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_disabled</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">):</span>
</span><span id="1-345">            <span class="bp">self</span><span class="o">.</span><span class="n">on_dropped_event</span><span class="p">(</span><span class="s2">&quot;self_rate_limits&quot;</span><span class="p">)</span>
</span><span id="1-346">            <span class="bp">self</span><span class="o">.</span><span class="n">record_lost_event</span><span class="p">(</span><span class="s2">&quot;ratelimit_backoff&quot;</span><span class="p">,</span> <span class="n">data_category</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
</span><span id="1-347">            <span class="k">return</span> <span class="kc">None</span>
</span><span id="1-348">
</span><span id="1-349">        <span class="n">body</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
</span><span id="1-350">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compresslevel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="1-351">            <span class="n">body</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json_dumps</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
</span><span id="1-352">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-353">            <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span>
</span><span id="1-354">                <span class="n">fileobj</span><span class="o">=</span><span class="n">body</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">compresslevel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_compresslevel</span>
</span><span id="1-355">            <span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="1-356">                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json_dumps</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
</span><span id="1-357">
</span><span id="1-358">        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">parsed_dsn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="1-359">        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="1-360">            <span class="s2">&quot;Sending event, type:</span><span class="si">%s</span><span class="s2"> level:</span><span class="si">%s</span><span class="s2"> event_id:</span><span class="si">%s</span><span class="s2"> project:</span><span class="si">%s</span><span class="s2"> host:</span><span class="si">%s</span><span class="s2">&quot;</span>
</span><span id="1-361">            <span class="o">%</span> <span class="p">(</span>
</span><span id="1-362">                <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;null&quot;</span><span class="p">,</span>
</span><span id="1-363">                <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;level&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;null&quot;</span><span class="p">,</span>
</span><span id="1-364">                <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;event_id&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;null&quot;</span><span class="p">,</span>
</span><span id="1-365">                <span class="bp">self</span><span class="o">.</span><span class="n">parsed_dsn</span><span class="o">.</span><span class="n">project_id</span><span class="p">,</span>
</span><span id="1-366">                <span class="bp">self</span><span class="o">.</span><span class="n">parsed_dsn</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
</span><span id="1-367">            <span class="p">)</span>
</span><span id="1-368">        <span class="p">)</span>
</span><span id="1-369">
</span><span id="1-370">        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="1-371">            <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
</span><span id="1-372">        <span class="p">}</span>
</span><span id="1-373">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compresslevel</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="1-374">            <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Content-Encoding&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;gzip&quot;</span>
</span><span id="1-375">
</span><span id="1-376">        <span class="bp">self</span><span class="o">.</span><span class="n">_send_request</span><span class="p">(</span><span class="n">body</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(),</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
</span><span id="1-377">        <span class="k">return</span> <span class="kc">None</span>
</span><span id="1-378">
</span><span id="1-379">    <span class="k">def</span> <span class="nf">_send_envelope</span><span class="p">(</span>
</span><span id="1-380">        <span class="bp">self</span><span class="p">,</span> <span class="n">envelope</span>  <span class="c1"># type: Envelope</span>
</span><span id="1-381">    <span class="p">):</span>
</span><span id="1-382">        <span class="c1"># type: (...) -&gt; None</span>
</span><span id="1-383">
</span><span id="1-384">        <span class="c1"># remove all items from the envelope which are over quota</span>
</span><span id="1-385">        <span class="n">new_items</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="1-386">        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">envelope</span><span class="o">.</span><span class="n">items</span><span class="p">:</span>
</span><span id="1-387">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_disabled</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">data_category</span><span class="p">):</span>
</span><span id="1-388">                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">data_category</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;transaction&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;default&quot;</span><span class="p">):</span>
</span><span id="1-389">                    <span class="bp">self</span><span class="o">.</span><span class="n">on_dropped_event</span><span class="p">(</span><span class="s2">&quot;self_rate_limits&quot;</span><span class="p">)</span>
</span><span id="1-390">                <span class="bp">self</span><span class="o">.</span><span class="n">record_lost_event</span><span class="p">(</span><span class="s2">&quot;ratelimit_backoff&quot;</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span><span class="n">item</span><span class="p">)</span>
</span><span id="1-391">            <span class="k">else</span><span class="p">:</span>
</span><span id="1-392">                <span class="n">new_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span id="1-393">
</span><span id="1-394">        <span class="c1"># Since we&#39;re modifying the envelope here make a copy so that others</span>
</span><span id="1-395">        <span class="c1"># that hold references do not see their envelope modified.</span>
</span><span id="1-396">        <span class="n">envelope</span> <span class="o">=</span> <span class="n">Envelope</span><span class="p">(</span><span class="n">headers</span><span class="o">=</span><span class="n">envelope</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span> <span class="n">items</span><span class="o">=</span><span class="n">new_items</span><span class="p">)</span>
</span><span id="1-397">
</span><span id="1-398">        <span class="k">if</span> <span class="ow">not</span> <span class="n">envelope</span><span class="o">.</span><span class="n">items</span><span class="p">:</span>
</span><span id="1-399">            <span class="k">return</span> <span class="kc">None</span>
</span><span id="1-400">
</span><span id="1-401">        <span class="c1"># since we&#39;re already in the business of sending out an envelope here</span>
</span><span id="1-402">        <span class="c1"># check if we have one pending for the stats session envelopes so we</span>
</span><span id="1-403">        <span class="c1"># can attach it to this enveloped scheduled for sending.  This will</span>
</span><span id="1-404">        <span class="c1"># currently typically attach the client report to the most recent</span>
</span><span id="1-405">        <span class="c1"># session update.</span>
</span><span id="1-406">        <span class="n">client_report_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_pending_client_report</span><span class="p">(</span><span class="n">interval</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
</span><span id="1-407">        <span class="k">if</span> <span class="n">client_report_item</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-408">            <span class="n">envelope</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">client_report_item</span><span class="p">)</span>
</span><span id="1-409">
</span><span id="1-410">        <span class="n">body</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
</span><span id="1-411">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compresslevel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="1-412">            <span class="n">envelope</span><span class="o">.</span><span class="n">serialize_into</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
</span><span id="1-413">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-414">            <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span>
</span><span id="1-415">                <span class="n">fileobj</span><span class="o">=</span><span class="n">body</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">compresslevel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_compresslevel</span>
</span><span id="1-416">            <span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="1-417">                <span class="n">envelope</span><span class="o">.</span><span class="n">serialize_into</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span><span id="1-418">
</span><span id="1-419">        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">parsed_dsn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="1-420">        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="1-421">            <span class="s2">&quot;Sending envelope [</span><span class="si">%s</span><span class="s2">] project:</span><span class="si">%s</span><span class="s2"> host:</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="1-422">            <span class="n">envelope</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
</span><span id="1-423">            <span class="bp">self</span><span class="o">.</span><span class="n">parsed_dsn</span><span class="o">.</span><span class="n">project_id</span><span class="p">,</span>
</span><span id="1-424">            <span class="bp">self</span><span class="o">.</span><span class="n">parsed_dsn</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
</span><span id="1-425">        <span class="p">)</span>
</span><span id="1-426">
</span><span id="1-427">        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="1-428">            <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/x-sentry-envelope&quot;</span><span class="p">,</span>
</span><span id="1-429">        <span class="p">}</span>
</span><span id="1-430">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compresslevel</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="1-431">            <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Content-Encoding&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;gzip&quot;</span>
</span><span id="1-432">
</span><span id="1-433">        <span class="bp">self</span><span class="o">.</span><span class="n">_send_request</span><span class="p">(</span>
</span><span id="1-434">            <span class="n">body</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(),</span>
</span><span id="1-435">            <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
</span><span id="1-436">            <span class="n">endpoint_type</span><span class="o">=</span><span class="s2">&quot;envelope&quot;</span><span class="p">,</span>
</span><span id="1-437">            <span class="n">envelope</span><span class="o">=</span><span class="n">envelope</span><span class="p">,</span>
</span><span id="1-438">        <span class="p">)</span>
</span><span id="1-439">        <span class="k">return</span> <span class="kc">None</span>
</span><span id="1-440">
</span><span id="1-441">    <span class="k">def</span> <span class="nf">_get_pool_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ca_certs</span><span class="p">):</span>
</span><span id="1-442">        <span class="c1"># type: (Optional[Any]) -&gt; Dict[str, Any]</span>
</span><span id="1-443">        <span class="n">options</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="1-444">            <span class="s2">&quot;num_pools&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_pools</span><span class="p">,</span>
</span><span id="1-445">            <span class="s2">&quot;cert_reqs&quot;</span><span class="p">:</span> <span class="s2">&quot;CERT_REQUIRED&quot;</span><span class="p">,</span>
</span><span id="1-446">            <span class="s2">&quot;ca_certs&quot;</span><span class="p">:</span> <span class="n">ca_certs</span> <span class="ow">or</span> <span class="n">certifi</span><span class="o">.</span><span class="n">where</span><span class="p">(),</span>
</span><span id="1-447">        <span class="p">}</span>
</span><span id="1-448">
</span><span id="1-449">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;socket_options&quot;</span><span class="p">]:</span>
</span><span id="1-450">            <span class="n">options</span><span class="p">[</span><span class="s2">&quot;socket_options&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;socket_options&quot;</span><span class="p">]</span>
</span><span id="1-451">
</span><span id="1-452">        <span class="k">return</span> <span class="n">options</span>
</span><span id="1-453">
</span><span id="1-454">    <span class="k">def</span> <span class="nf">_in_no_proxy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parsed_dsn</span><span class="p">):</span>
</span><span id="1-455">        <span class="c1"># type: (Dsn) -&gt; bool</span>
</span><span id="1-456">        <span class="n">no_proxy</span> <span class="o">=</span> <span class="n">getproxies</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;no&quot;</span><span class="p">)</span>
</span><span id="1-457">        <span class="k">if</span> <span class="ow">not</span> <span class="n">no_proxy</span><span class="p">:</span>
</span><span id="1-458">            <span class="k">return</span> <span class="kc">False</span>
</span><span id="1-459">        <span class="k">for</span> <span class="n">host</span> <span class="ow">in</span> <span class="n">no_proxy</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">):</span>
</span><span id="1-460">            <span class="n">host</span> <span class="o">=</span> <span class="n">host</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="1-461">            <span class="k">if</span> <span class="n">parsed_dsn</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">host</span><span class="p">)</span> <span class="ow">or</span> <span class="n">parsed_dsn</span><span class="o">.</span><span class="n">netloc</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">host</span><span class="p">):</span>
</span><span id="1-462">                <span class="k">return</span> <span class="kc">True</span>
</span><span id="1-463">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="1-464">
</span><span id="1-465">    <span class="k">def</span> <span class="nf">_make_pool</span><span class="p">(</span>
</span><span id="1-466">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-467">        <span class="n">parsed_dsn</span><span class="p">,</span>  <span class="c1"># type: Dsn</span>
</span><span id="1-468">        <span class="n">http_proxy</span><span class="p">,</span>  <span class="c1"># type: Optional[str]</span>
</span><span id="1-469">        <span class="n">https_proxy</span><span class="p">,</span>  <span class="c1"># type: Optional[str]</span>
</span><span id="1-470">        <span class="n">ca_certs</span><span class="p">,</span>  <span class="c1"># type: Optional[Any]</span>
</span><span id="1-471">        <span class="n">proxy_headers</span><span class="p">,</span>  <span class="c1"># type: Optional[Dict[str, str]]</span>
</span><span id="1-472">    <span class="p">):</span>
</span><span id="1-473">        <span class="c1"># type: (...) -&gt; Union[PoolManager, ProxyManager]</span>
</span><span id="1-474">        <span class="n">proxy</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="1-475">        <span class="n">no_proxy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_in_no_proxy</span><span class="p">(</span><span class="n">parsed_dsn</span><span class="p">)</span>
</span><span id="1-476">
</span><span id="1-477">        <span class="c1"># try HTTPS first</span>
</span><span id="1-478">        <span class="k">if</span> <span class="n">parsed_dsn</span><span class="o">.</span><span class="n">scheme</span> <span class="o">==</span> <span class="s2">&quot;https&quot;</span> <span class="ow">and</span> <span class="p">(</span><span class="n">https_proxy</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
</span><span id="1-479">            <span class="n">proxy</span> <span class="o">=</span> <span class="n">https_proxy</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">no_proxy</span> <span class="ow">and</span> <span class="n">getproxies</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;https&quot;</span><span class="p">))</span>
</span><span id="1-480">
</span><span id="1-481">        <span class="c1"># maybe fallback to HTTP proxy</span>
</span><span id="1-482">        <span class="k">if</span> <span class="ow">not</span> <span class="n">proxy</span> <span class="ow">and</span> <span class="p">(</span><span class="n">http_proxy</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
</span><span id="1-483">            <span class="n">proxy</span> <span class="o">=</span> <span class="n">http_proxy</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">no_proxy</span> <span class="ow">and</span> <span class="n">getproxies</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">))</span>
</span><span id="1-484">
</span><span id="1-485">        <span class="n">opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pool_options</span><span class="p">(</span><span class="n">ca_certs</span><span class="p">)</span>
</span><span id="1-486">
</span><span id="1-487">        <span class="k">if</span> <span class="n">proxy</span><span class="p">:</span>
</span><span id="1-488">            <span class="k">if</span> <span class="n">proxy_headers</span><span class="p">:</span>
</span><span id="1-489">                <span class="n">opts</span><span class="p">[</span><span class="s2">&quot;proxy_headers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">proxy_headers</span>
</span><span id="1-490">
</span><span id="1-491">            <span class="k">if</span> <span class="n">proxy</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;socks&quot;</span><span class="p">):</span>
</span><span id="1-492">                <span class="n">use_socks_proxy</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="1-493">                <span class="k">try</span><span class="p">:</span>
</span><span id="1-494">                    <span class="c1"># Check if PySocks depencency is available</span>
</span><span id="1-495">                    <span class="kn">from</span> <span class="nn">urllib3.contrib.socks</span> <span class="kn">import</span> <span class="n">SOCKSProxyManager</span>
</span><span id="1-496">                <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
</span><span id="1-497">                    <span class="n">use_socks_proxy</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-498">                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="1-499">                        <span class="s2">&quot;You have configured a SOCKS proxy (</span><span class="si">%s</span><span class="s2">) but support for SOCKS proxies is not installed. Disabling proxy support. Please add `PySocks` (or `urllib3` with the `[socks]` extra) to your dependencies.&quot;</span><span class="p">,</span>
</span><span id="1-500">                        <span class="n">proxy</span><span class="p">,</span>
</span><span id="1-501">                    <span class="p">)</span>
</span><span id="1-502">
</span><span id="1-503">                <span class="k">if</span> <span class="n">use_socks_proxy</span><span class="p">:</span>
</span><span id="1-504">                    <span class="k">return</span> <span class="n">SOCKSProxyManager</span><span class="p">(</span><span class="n">proxy</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">)</span>
</span><span id="1-505">                <span class="k">else</span><span class="p">:</span>
</span><span id="1-506">                    <span class="k">return</span> <span class="n">urllib3</span><span class="o">.</span><span class="n">PoolManager</span><span class="p">(</span><span class="o">**</span><span class="n">opts</span><span class="p">)</span>
</span><span id="1-507">            <span class="k">else</span><span class="p">:</span>
</span><span id="1-508">                <span class="k">return</span> <span class="n">urllib3</span><span class="o">.</span><span class="n">ProxyManager</span><span class="p">(</span><span class="n">proxy</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">)</span>
</span><span id="1-509">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-510">            <span class="k">return</span> <span class="n">urllib3</span><span class="o">.</span><span class="n">PoolManager</span><span class="p">(</span><span class="o">**</span><span class="n">opts</span><span class="p">)</span>
</span><span id="1-511">
<div class="viewcode-block" id="HttpTransport.capture_event">
<a class="viewcode-back" href="../../apidocs.html#sentry_sdk.HttpTransport.capture_event">[docs]</a>
</span><span id="1-512">    <span class="k">def</span> <span class="nf">capture_event</span><span class="p">(</span>
</span><span id="1-513">        <span class="bp">self</span><span class="p">,</span> <span class="n">event</span>  <span class="c1"># type: Event</span>
</span><span id="1-514">    <span class="p">):</span>
</span><span id="1-515">        <span class="c1"># type: (...) -&gt; None</span>
</span><span id="1-516">        <span class="n">hub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hub_cls</span><span class="o">.</span><span class="n">current</span>
</span><span id="1-517">
</span><span id="1-518">        <span class="k">def</span> <span class="nf">send_event_wrapper</span><span class="p">():</span>
</span><span id="1-519">            <span class="c1"># type: () -&gt; None</span>
</span><span id="1-520">            <span class="k">with</span> <span class="n">hub</span><span class="p">:</span>
</span><span id="1-521">                <span class="k">with</span> <span class="n">capture_internal_exceptions</span><span class="p">():</span>
</span><span id="1-522">                    <span class="bp">self</span><span class="o">.</span><span class="n">_send_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</span><span id="1-523">                    <span class="bp">self</span><span class="o">.</span><span class="n">_flush_client_reports</span><span class="p">()</span>
</span><span id="1-524">
</span><span id="1-525">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_worker</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">send_event_wrapper</span><span class="p">):</span>
</span><span id="1-526">            <span class="bp">self</span><span class="o">.</span><span class="n">on_dropped_event</span><span class="p">(</span><span class="s2">&quot;full_queue&quot;</span><span class="p">)</span>
</span><span id="1-527">            <span class="bp">self</span><span class="o">.</span><span class="n">record_lost_event</span><span class="p">(</span><span class="s2">&quot;queue_overflow&quot;</span><span class="p">,</span> <span class="n">data_category</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">)</span></div>

</span><span id="1-528">
<div class="viewcode-block" id="HttpTransport.capture_envelope">
<a class="viewcode-back" href="../../apidocs.html#sentry_sdk.HttpTransport.capture_envelope">[docs]</a>
</span><span id="1-529">    <span class="k">def</span> <span class="nf">capture_envelope</span><span class="p">(</span>
</span><span id="1-530">        <span class="bp">self</span><span class="p">,</span> <span class="n">envelope</span>  <span class="c1"># type: Envelope</span>
</span><span id="1-531">    <span class="p">):</span>
</span><span id="1-532">        <span class="c1"># type: (...) -&gt; None</span>
</span><span id="1-533">        <span class="n">hub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hub_cls</span><span class="o">.</span><span class="n">current</span>
</span><span id="1-534">
</span><span id="1-535">        <span class="k">def</span> <span class="nf">send_envelope_wrapper</span><span class="p">():</span>
</span><span id="1-536">            <span class="c1"># type: () -&gt; None</span>
</span><span id="1-537">            <span class="k">with</span> <span class="n">hub</span><span class="p">:</span>
</span><span id="1-538">                <span class="k">with</span> <span class="n">capture_internal_exceptions</span><span class="p">():</span>
</span><span id="1-539">                    <span class="bp">self</span><span class="o">.</span><span class="n">_send_envelope</span><span class="p">(</span><span class="n">envelope</span><span class="p">)</span>
</span><span id="1-540">                    <span class="bp">self</span><span class="o">.</span><span class="n">_flush_client_reports</span><span class="p">()</span>
</span><span id="1-541">
</span><span id="1-542">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_worker</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">send_envelope_wrapper</span><span class="p">):</span>
</span><span id="1-543">            <span class="bp">self</span><span class="o">.</span><span class="n">on_dropped_event</span><span class="p">(</span><span class="s2">&quot;full_queue&quot;</span><span class="p">)</span>
</span><span id="1-544">            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">envelope</span><span class="o">.</span><span class="n">items</span><span class="p">:</span>
</span><span id="1-545">                <span class="bp">self</span><span class="o">.</span><span class="n">record_lost_event</span><span class="p">(</span><span class="s2">&quot;queue_overflow&quot;</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span><span class="n">item</span><span class="p">)</span></div>

</span><span id="1-546">
<div class="viewcode-block" id="HttpTransport.flush">
<a class="viewcode-back" href="../../apidocs.html#sentry_sdk.HttpTransport.flush">[docs]</a>
</span><span id="1-547">    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span>
</span><span id="1-548">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-549">        <span class="n">timeout</span><span class="p">,</span>  <span class="c1"># type: float</span>
</span><span id="1-550">        <span class="n">callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># type: Optional[Any]</span>
</span><span id="1-551">    <span class="p">):</span>
</span><span id="1-552">        <span class="c1"># type: (...) -&gt; None</span>
</span><span id="1-553">        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Flushing HTTP transport&quot;</span><span class="p">)</span>
</span><span id="1-554">
</span><span id="1-555">        <span class="k">if</span> <span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="1-556">            <span class="bp">self</span><span class="o">.</span><span class="n">_worker</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flush_client_reports</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</span><span id="1-557">            <span class="bp">self</span><span class="o">.</span><span class="n">_worker</span><span class="o">.</span><span class="n">flush</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span></div>

</span><span id="1-558">
<div class="viewcode-block" id="HttpTransport.kill">
<a class="viewcode-back" href="../../apidocs.html#sentry_sdk.HttpTransport.kill">[docs]</a>
</span><span id="1-559">    <span class="k">def</span> <span class="nf">kill</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="1-560">        <span class="c1"># type: () -&gt; None</span>
</span><span id="1-561">        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Killing HTTP transport&quot;</span><span class="p">)</span>
</span><span id="1-562">        <span class="bp">self</span><span class="o">.</span><span class="n">_worker</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span></div>
</div>

</span><span id="1-563">
</span><span id="1-564">
</span><span id="1-565"><span class="k">class</span> <span class="nc">_FunctionTransport</span><span class="p">(</span><span class="n">Transport</span><span class="p">):</span>
</span><span id="1-566">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="1-567">        <span class="bp">self</span><span class="p">,</span> <span class="n">func</span>  <span class="c1"># type: Callable[[Event], None]</span>
</span><span id="1-568">    <span class="p">):</span>
</span><span id="1-569">        <span class="c1"># type: (...) -&gt; None</span>
</span><span id="1-570">        <span class="n">Transport</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="1-571">        <span class="bp">self</span><span class="o">.</span><span class="n">_func</span> <span class="o">=</span> <span class="n">func</span>
</span><span id="1-572">
</span><span id="1-573">    <span class="k">def</span> <span class="nf">capture_event</span><span class="p">(</span>
</span><span id="1-574">        <span class="bp">self</span><span class="p">,</span> <span class="n">event</span>  <span class="c1"># type: Event</span>
</span><span id="1-575">    <span class="p">):</span>
</span><span id="1-576">        <span class="c1"># type: (...) -&gt; None</span>
</span><span id="1-577">        <span class="bp">self</span><span class="o">.</span><span class="n">_func</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</span><span id="1-578">        <span class="k">return</span> <span class="kc">None</span>
</span><span id="1-579">
</span><span id="1-580">
</span><span id="1-581"><span class="k">def</span> <span class="nf">make_transport</span><span class="p">(</span><span class="n">options</span><span class="p">):</span>
</span><span id="1-582">    <span class="c1"># type: (Dict[str, Any]) -&gt; Optional[Transport]</span>
</span><span id="1-583">    <span class="n">ref_transport</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;transport&quot;</span><span class="p">]</span>
</span><span id="1-584">
</span><span id="1-585">    <span class="c1"># If no transport is given, we use the http transport class</span>
</span><span id="1-586">    <span class="k">if</span> <span class="n">ref_transport</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-587">        <span class="n">transport_cls</span> <span class="o">=</span> <span class="n">HttpTransport</span>  <span class="c1"># type: Type[Transport]</span>
</span><span id="1-588">    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ref_transport</span><span class="p">,</span> <span class="n">Transport</span><span class="p">):</span>
</span><span id="1-589">        <span class="k">return</span> <span class="n">ref_transport</span>
</span><span id="1-590">    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ref_transport</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">ref_transport</span><span class="p">,</span> <span class="n">Transport</span><span class="p">):</span>
</span><span id="1-591">        <span class="n">transport_cls</span> <span class="o">=</span> <span class="n">ref_transport</span>
</span><span id="1-592">    <span class="k">elif</span> <span class="nb">callable</span><span class="p">(</span><span class="n">ref_transport</span><span class="p">):</span>
</span><span id="1-593">        <span class="k">return</span> <span class="n">_FunctionTransport</span><span class="p">(</span><span class="n">ref_transport</span><span class="p">)</span>
</span><span id="1-594">
</span><span id="1-595">    <span class="c1"># if a transport class is given only instantiate it if the dsn is not</span>
</span><span id="1-596">    <span class="c1"># empty or None</span>
</span><span id="1-597">    <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;dsn&quot;</span><span class="p">]:</span>
</span><span id="1-598">        <span class="k">return</span> <span class="n">transport_cls</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
</span><span id="1-599">
</span><span id="1-600">    <span class="k">return</span> <span class="kc">None</span>
</span></pre></div>
        </article>
        
        <div class="navigation flex print:hidden">
  
  
</div>
        
      </div>
    </div>
  </main>
</div>
<footer class="sy-foot">
  <div class="sy-foot-inner sy-container mx-auto">
    
    <div class="sy-foot-reserved md:flex justify-between items-center">
      <div class="sy-foot-copyright"><p>2019-2024, Sentry Team and Contributors</p>
        
        <p>
          Made with
          
          <a href="https://www.sphinx-doc.org/">Sphinx</a> and
          
          <a href="https://shibuya.lepture.com">Shibuya theme</a>.
        </p>
      </div>
      <div class="sy-foot-socials">
          <a href="https://github.com/getsentry/sentry-python" aria-label="GitHub"><i class="i-icon github"></i></a>
      </div>
    </div>
  </div>
</footer></div>
      <script src="../../_static/documentation_options.js?v=a750e919"></script>
      <script src="../../_static/doctools.js?v=888ff710"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/shibuya.js?v=999236dc"></script>
    
</body>
</html>