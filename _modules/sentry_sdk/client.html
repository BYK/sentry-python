<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>sentry_sdk.client - sentry-python 1.39.1 documentation</title>
    <link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" />
  <script>
    const isDarkTheme = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    const sessionTheme = sessionStorage['_theme']
    if (sessionTheme) {
      document.documentElement.classList.add(sessionTheme)
    } else if (isDarkTheme) {
      document.documentElement.classList.add('dark')
    }
  </script><link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=aecf457f" />
    <link rel="stylesheet" type="text/css" href="../../_static/shibuya.css?v=28c32440" />
    <link media="print" rel="stylesheet" type="text/css" href="../../_static/print.css?v=ee381b95" />
    <style>
:root {
  --sy-f-sys:-apple-system, BlinkMacSystemFont, Segoe UI, Oxygen, Ubuntu, Droid Sans, Helvetica Neue;--sy-f-cjk:PingFang SC, Hiragino Sans GB, Droid Sans Fallback, Microsoft YaHei;--sy-f-heading:var(--sy-f-sys), var(--sy-f-cjk), sans-serif;--sy-f-text:var(--sy-f-sys), var(--sy-f-cjk), sans-serif;--sy-f-mono:Menlo, Monaco, Consolas, "Courier New", monospace;--sy-c-divider:rgba(var(--sy-rc-text), 0.1);--sy-c-divider-weak:rgba(var(--sy-rc-text), 0.05);--sy-c-border:rgba(var(--sy-rc-text), 0.14);--sy-s-banner-height:0rem;--sy-s-navbar-height:56px;--sy-s-offset-top:calc(var(--sy-s-navbar-height) + var(--sy-s-banner-height));--sy-c-link:rgb(var(--sy-rc-theme));--sy-c-link-weak:rgba(var(--sy-rc-theme), 0.86);
  --sy-rc-theme:143, 118, 214;--sy-rc-bg:255, 255, 255;--sy-rc-invert:0, 0, 0;--sy-rc-text:0, 0, 0;--sy-c-bg:#fff;--sy-c-bg-weak:#f9f9f9;--sy-c-text:#374151;--sy-c-text-weak:#6b7280;--sy-c-heading:#111827;--sy-c-bold:#111827;--sy-c-foot-text:#232226;--sy-c-foot-bg:#fafafa;--sy-c-foot-divider:#f0f0f0;
}
@media (prefers-color-scheme: light) {
  :root {
    --sy-rc-theme:143, 118, 214;--sy-rc-bg:255, 255, 255;--sy-rc-invert:0, 0, 0;--sy-rc-text:0, 0, 0;--sy-c-bg:#fff;--sy-c-bg-weak:#f9f9f9;--sy-c-text:#374151;--sy-c-text-weak:#6b7280;--sy-c-heading:#111827;--sy-c-bold:#111827;--sy-c-foot-text:#232226;--sy-c-foot-bg:#fafafa;--sy-c-foot-divider:#f0f0f0;
  }
}
@media (prefers-color-scheme: dark) {
  :root {
    --sy-rc-theme:143, 118, 214;--sy-rc-bg:18, 18, 18;--sy-rc-invert:255, 255, 255;--sy-rc-text:255, 255, 255;--sy-c-bg:#121212;--sy-c-bg-weak:#212833;--sy-c-text:#cedbea;--sy-c-text-weak:#77889f;--sy-c-heading:#ebf0f4;--sy-c-bold:#ebf0f4;--sy-c-foot-text:#eee;--sy-c-foot-bg:#000;--sy-c-foot-divider:#000;
  }
}
html.light {
  --sy-rc-theme:143, 118, 214;--sy-rc-bg:255, 255, 255;--sy-rc-invert:0, 0, 0;--sy-rc-text:0, 0, 0;--sy-c-bg:#fff;--sy-c-bg-weak:#f9f9f9;--sy-c-text:#374151;--sy-c-text-weak:#6b7280;--sy-c-heading:#111827;--sy-c-bold:#111827;--sy-c-foot-text:#232226;--sy-c-foot-bg:#fafafa;--sy-c-foot-divider:#f0f0f0;
}
html.dark {
  --sy-rc-theme:143, 118, 214;--sy-rc-bg:18, 18, 18;--sy-rc-invert:255, 255, 255;--sy-rc-text:255, 255, 255;--sy-c-bg:#121212;--sy-c-bg-weak:#212833;--sy-c-text:#cedbea;--sy-c-text-weak:#77889f;--sy-c-heading:#ebf0f4;--sy-c-bold:#ebf0f4;--sy-c-foot-text:#eee;--sy-c-foot-bg:#000;--sy-c-foot-divider:#000;
}
</style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --sy-f-heading: Inter, var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
}
</style>
    <meta property="og:type" content="website"/><meta property="og:title" content="sentry_sdk.client"/>
<meta name="twitter:card" content="summary"/></head>
<body><div class="document"><div class="sy-head">
  <div class="sy-head-blur"></div>
  <div class="sy-head-inner sy-container mx-auto">
    <a class="sy-head-brand mr-4" href="../../index.html">
      
      
      <strong>sentry-python</strong>
    </a>
    <div class="sy-head-links" id="NavLinks">
      <nav class="sy-head-nav"></nav>
      <div class="sy-head-extra flex items-center print:hidden"><form class="searchbox flex items-center" action="../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <kbd>/</kbd>
</form>
        
        
        <div class="sy-head-social flex items-center">
            <a class="flex items-center" href="https://github.com/getsentry/sentry-python" aria-label="GitHub">
              <i class="i-icon github"></i>
            </a>
        </div>
      </div>
    </div>
    <div class="sy-head-actions flex items-center shrink-0 print:hidden">
      <button class="js-theme theme-switch flex items-center" data-aria-light="Switch to dark mode" data-aria-dark="Switch to light mode">
        <i class="i-icon theme-icon"></i>
      </button>
      <button class="md:hidden flex items-center js-menu" aria-label="Menu" type="button" aria-controls="NavLinks" aria-expanded="false">
        <div class="hamburger">
          <span class="hamburger_1"></span>
          <span class="hamburger_2 -translate-x-2"></span>
          <span class="hamburger_3 -translate-x-1"></span>
        </div>
      </button>
    </div>
  </div>
</div>
<div class="sy-page sy-container flex mx-auto">
  <aside id="lside" class="sy-lside md:w-72 md:shrink-0 print:hidden">
    <div class="sy-lside-inner md:sticky">
      <div class="sy-scrollbar p-6">
        <div class="globaltoc" data-expand-depth="0"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">Top Level API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../integrations.html">Integrations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../apidocs.html">API Docs</a></li>
</ul>

        </div>
      </div>
      
    </div>
  </aside>
  <div class="lside-overlay js-menu" role="button" aria-label="Close left sidebar" aria-controls="lside" aria-expanded="false"></div>
  <aside id="rside" class="sy-rside pb-3 w-64 shrink-0 order-last">
    <button class="rside-close js-menu xl:hidden" aria-label="Close Table of Contents" type="button" aria-controls="rside" aria-expanded="false">
      <i class="i-icon close"></i>
    </button>
    <div class="sy-scrollbar sy-rside-inner px-6 xl:top-16 xl:sticky xl:pl-0 pt-6 pb-4"><div id="ethical-ad-placement" data-ea-publisher="readthedocs"></div>
    </div>
  </aside>
  <div class="rside-overlay js-menu" role="button" aria-label="Close Table of Contents" aria-controls="rside" aria-expanded="false"></div>
  <main class="sy-main w-full max-sm:max-w-full print:pt-6">
    <div class="sy-breadcrumbs" role="navigation">
  <div class="sy-breadcrumbs-inner flex items-center">
    <div class="md:hidden mr-3">
      <button class="js-menu" aria-label="Menu" type="button" aria-controls="lside" aria-expanded="false">
        <i class="i-icon menu"></i>
      </button>
    </div>
    <ul class="flex-1">
      
      
      <li><a href="../../index.html">sentry-python</a><span>/</span></li>
      
      <li><a href="../index.html">Module code</a><span>/</span></li>
      
      <li><strong>sentry_sdk.client</strong></li>
      
      
    </ul>
    <div class="xl:hidden ml-1">
      <button class="js-menu" aria-label="Show table of contents" type="button" aria-controls="rside"
        aria-expanded="false">
        <i class="i-icon outdent"></i>
      </button>
    </div>
  </div>
</div>
    <div class="flex flex-col break-words justify-between">
      <div class="min-w-0 max-w-6xl px-6 pb-6 pt-8 xl:px-12">
        <article class="yue" role="main">
          <h1>Source code for sentry_sdk.client</h1><div class="highlight"><pre>
<span></span><span id="1-1"><span class="kn">from</span> <span class="nn">importlib</span> <span class="kn">import</span> <span class="n">import_module</span>
</span><span id="1-2"><span class="kn">import</span> <span class="nn">os</span>
</span><span id="1-3"><span class="kn">import</span> <span class="nn">uuid</span>
</span><span id="1-4"><span class="kn">import</span> <span class="nn">random</span>
</span><span id="1-5"><span class="kn">import</span> <span class="nn">socket</span>
</span><span id="1-6">
</span><span id="1-7"><span class="kn">from</span> <span class="nn">sentry_sdk._compat</span> <span class="kn">import</span> <span class="n">datetime_utcnow</span><span class="p">,</span> <span class="n">string_types</span><span class="p">,</span> <span class="n">text_type</span><span class="p">,</span> <span class="n">iteritems</span>
</span><span id="1-8"><span class="kn">from</span> <span class="nn">sentry_sdk.utils</span> <span class="kn">import</span> <span class="p">(</span>
</span><span id="1-9">    <span class="n">capture_internal_exceptions</span><span class="p">,</span>
</span><span id="1-10">    <span class="n">current_stacktrace</span><span class="p">,</span>
</span><span id="1-11">    <span class="n">disable_capture_event</span><span class="p">,</span>
</span><span id="1-12">    <span class="n">format_timestamp</span><span class="p">,</span>
</span><span id="1-13">    <span class="n">get_sdk_name</span><span class="p">,</span>
</span><span id="1-14">    <span class="n">get_type_name</span><span class="p">,</span>
</span><span id="1-15">    <span class="n">get_default_release</span><span class="p">,</span>
</span><span id="1-16">    <span class="n">handle_in_app</span><span class="p">,</span>
</span><span id="1-17">    <span class="n">logger</span><span class="p">,</span>
</span><span id="1-18"><span class="p">)</span>
</span><span id="1-19"><span class="kn">from</span> <span class="nn">sentry_sdk.serializer</span> <span class="kn">import</span> <span class="n">serialize</span>
</span><span id="1-20"><span class="kn">from</span> <span class="nn">sentry_sdk.tracing</span> <span class="kn">import</span> <span class="n">trace</span><span class="p">,</span> <span class="n">has_tracing_enabled</span>
</span><span id="1-21"><span class="kn">from</span> <span class="nn">sentry_sdk.transport</span> <span class="kn">import</span> <span class="n">make_transport</span>
</span><span id="1-22"><span class="kn">from</span> <span class="nn">sentry_sdk.consts</span> <span class="kn">import</span> <span class="p">(</span>
</span><span id="1-23">    <span class="n">DEFAULT_MAX_VALUE_LENGTH</span><span class="p">,</span>
</span><span id="1-24">    <span class="n">DEFAULT_OPTIONS</span><span class="p">,</span>
</span><span id="1-25">    <span class="n">INSTRUMENTER</span><span class="p">,</span>
</span><span id="1-26">    <span class="n">VERSION</span><span class="p">,</span>
</span><span id="1-27">    <span class="n">ClientConstructor</span><span class="p">,</span>
</span><span id="1-28"><span class="p">)</span>
</span><span id="1-29"><span class="kn">from</span> <span class="nn">sentry_sdk.integrations</span> <span class="kn">import</span> <span class="n">_DEFAULT_INTEGRATIONS</span><span class="p">,</span> <span class="n">setup_integrations</span>
</span><span id="1-30"><span class="kn">from</span> <span class="nn">sentry_sdk.utils</span> <span class="kn">import</span> <span class="n">ContextVar</span>
</span><span id="1-31"><span class="kn">from</span> <span class="nn">sentry_sdk.sessions</span> <span class="kn">import</span> <span class="n">SessionFlusher</span>
</span><span id="1-32"><span class="kn">from</span> <span class="nn">sentry_sdk.envelope</span> <span class="kn">import</span> <span class="n">Envelope</span>
</span><span id="1-33"><span class="kn">from</span> <span class="nn">sentry_sdk.profiler</span> <span class="kn">import</span> <span class="n">has_profiling_enabled</span><span class="p">,</span> <span class="n">setup_profiler</span>
</span><span id="1-34"><span class="kn">from</span> <span class="nn">sentry_sdk.scrubber</span> <span class="kn">import</span> <span class="n">EventScrubber</span>
</span><span id="1-35"><span class="kn">from</span> <span class="nn">sentry_sdk.monitor</span> <span class="kn">import</span> <span class="n">Monitor</span>
</span><span id="1-36"><span class="kn">from</span> <span class="nn">sentry_sdk.spotlight</span> <span class="kn">import</span> <span class="n">setup_spotlight</span>
</span><span id="1-37">
</span><span id="1-38"><span class="kn">from</span> <span class="nn">sentry_sdk._types</span> <span class="kn">import</span> <span class="n">TYPE_CHECKING</span>
</span><span id="1-39">
</span><span id="1-40"><span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span id="1-41">    <span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>
</span><span id="1-42">    <span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span>
</span><span id="1-43">    <span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span>
</span><span id="1-44">    <span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>
</span><span id="1-45">    <span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Sequence</span>
</span><span id="1-46">
</span><span id="1-47">    <span class="kn">from</span> <span class="nn">sentry_sdk.scope</span> <span class="kn">import</span> <span class="n">Scope</span>
</span><span id="1-48">    <span class="kn">from</span> <span class="nn">sentry_sdk._types</span> <span class="kn">import</span> <span class="n">Event</span><span class="p">,</span> <span class="n">Hint</span>
</span><span id="1-49">    <span class="kn">from</span> <span class="nn">sentry_sdk.session</span> <span class="kn">import</span> <span class="n">Session</span>
</span><span id="1-50">
</span><span id="1-51">
</span><span id="1-52"><span class="n">_client_init_debug</span> <span class="o">=</span> <span class="n">ContextVar</span><span class="p">(</span><span class="s2">&quot;client_init_debug&quot;</span><span class="p">)</span>
</span><span id="1-53">
</span><span id="1-54">
</span><span id="1-55"><span class="n">SDK_INFO</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="1-56">    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;sentry.python&quot;</span><span class="p">,</span>  <span class="c1"># SDK name will be overridden after integrations have been loaded with sentry_sdk.integrations.setup_integrations()</span>
</span><span id="1-57">    <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">VERSION</span><span class="p">,</span>
</span><span id="1-58">    <span class="s2">&quot;packages&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;pypi:sentry-sdk&quot;</span><span class="p">,</span> <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">VERSION</span><span class="p">}],</span>
</span><span id="1-59"><span class="p">}</span>
</span><span id="1-60">
</span><span id="1-61">
</span><span id="1-62"><span class="k">def</span> <span class="nf">_get_options</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="1-63">    <span class="c1"># type: (*Optional[str], **Any) -&gt; Dict[str, Any]</span>
</span><span id="1-64">    <span class="k">if</span> <span class="n">args</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">text_type</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="nb">str</span><span class="p">))</span> <span class="ow">or</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="1-65">        <span class="n">dsn</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># type: Optional[str]</span>
</span><span id="1-66">        <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</span><span id="1-67">    <span class="k">else</span><span class="p">:</span>
</span><span id="1-68">        <span class="n">dsn</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="1-69">
</span><span id="1-70">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="1-71">        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Only single positional argument is expected&quot;</span><span class="p">)</span>
</span><span id="1-72">
</span><span id="1-73">    <span class="n">rv</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">DEFAULT_OPTIONS</span><span class="p">)</span>
</span><span id="1-74">    <span class="n">options</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="1-75">    <span class="k">if</span> <span class="n">dsn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dsn&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-76">        <span class="n">options</span><span class="p">[</span><span class="s2">&quot;dsn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dsn</span>
</span><span id="1-77">
</span><span id="1-78">    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">options</span><span class="p">):</span>
</span><span id="1-79">        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rv</span><span class="p">:</span>
</span><span id="1-80">            <span class="c1"># Option &quot;with_locals&quot; was renamed to &quot;include_local_variables&quot;</span>
</span><span id="1-81">            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;with_locals&quot;</span><span class="p">:</span>
</span><span id="1-82">                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="1-83">                    <span class="s2">&quot;Deprecated: The option &#39;with_locals&#39; was renamed to &#39;include_local_variables&#39;. &quot;</span>
</span><span id="1-84">                    <span class="s2">&quot;Please use &#39;include_local_variables&#39;. The option &#39;with_locals&#39; will be removed in the future.&quot;</span>
</span><span id="1-85">                <span class="p">)</span>
</span><span id="1-86">                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="1-87">                <span class="n">rv</span><span class="p">[</span><span class="s2">&quot;include_local_variables&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="1-88">                <span class="k">continue</span>
</span><span id="1-89">
</span><span id="1-90">            <span class="c1"># Option &quot;request_bodies&quot; was renamed to &quot;max_request_body_size&quot;</span>
</span><span id="1-91">            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;request_bodies&quot;</span><span class="p">:</span>
</span><span id="1-92">                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="1-93">                    <span class="s2">&quot;Deprecated: The option &#39;request_bodies&#39; was renamed to &#39;max_request_body_size&#39;. &quot;</span>
</span><span id="1-94">                    <span class="s2">&quot;Please use &#39;max_request_body_size&#39;. The option &#39;request_bodies&#39; will be removed in the future.&quot;</span>
</span><span id="1-95">                <span class="p">)</span>
</span><span id="1-96">                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="1-97">                <span class="n">rv</span><span class="p">[</span><span class="s2">&quot;max_request_body_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="1-98">                <span class="k">continue</span>
</span><span id="1-99">
</span><span id="1-100">            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Unknown option </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,))</span>
</span><span id="1-101">
</span><span id="1-102">        <span class="n">rv</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="1-103">
</span><span id="1-104">    <span class="k">if</span> <span class="n">rv</span><span class="p">[</span><span class="s2">&quot;dsn&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-105">        <span class="n">rv</span><span class="p">[</span><span class="s2">&quot;dsn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SENTRY_DSN&quot;</span><span class="p">)</span>
</span><span id="1-106">
</span><span id="1-107">    <span class="k">if</span> <span class="n">rv</span><span class="p">[</span><span class="s2">&quot;release&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-108">        <span class="n">rv</span><span class="p">[</span><span class="s2">&quot;release&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_default_release</span><span class="p">()</span>
</span><span id="1-109">
</span><span id="1-110">    <span class="k">if</span> <span class="n">rv</span><span class="p">[</span><span class="s2">&quot;environment&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-111">        <span class="n">rv</span><span class="p">[</span><span class="s2">&quot;environment&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SENTRY_ENVIRONMENT&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;production&quot;</span>
</span><span id="1-112">
</span><span id="1-113">    <span class="k">if</span> <span class="n">rv</span><span class="p">[</span><span class="s2">&quot;debug&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-114">        <span class="n">rv</span><span class="p">[</span><span class="s2">&quot;debug&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SENTRY_DEBUG&quot;</span><span class="p">,</span> <span class="s2">&quot;False&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span>
</span><span id="1-115">            <span class="s2">&quot;true&quot;</span><span class="p">,</span>
</span><span id="1-116">            <span class="s2">&quot;1&quot;</span><span class="p">,</span>
</span><span id="1-117">            <span class="s2">&quot;t&quot;</span><span class="p">,</span>
</span><span id="1-118">        <span class="p">)</span>
</span><span id="1-119">
</span><span id="1-120">    <span class="k">if</span> <span class="n">rv</span><span class="p">[</span><span class="s2">&quot;server_name&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s2">&quot;gethostname&quot;</span><span class="p">):</span>
</span><span id="1-121">        <span class="n">rv</span><span class="p">[</span><span class="s2">&quot;server_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>
</span><span id="1-122">
</span><span id="1-123">    <span class="k">if</span> <span class="n">rv</span><span class="p">[</span><span class="s2">&quot;instrumenter&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-124">        <span class="n">rv</span><span class="p">[</span><span class="s2">&quot;instrumenter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">INSTRUMENTER</span><span class="o">.</span><span class="n">SENTRY</span>
</span><span id="1-125">
</span><span id="1-126">    <span class="k">if</span> <span class="n">rv</span><span class="p">[</span><span class="s2">&quot;project_root&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-127">        <span class="k">try</span><span class="p">:</span>
</span><span id="1-128">            <span class="n">project_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
</span><span id="1-129">        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="1-130">            <span class="n">project_root</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="1-131">
</span><span id="1-132">        <span class="n">rv</span><span class="p">[</span><span class="s2">&quot;project_root&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">project_root</span>
</span><span id="1-133">
</span><span id="1-134">    <span class="k">if</span> <span class="n">rv</span><span class="p">[</span><span class="s2">&quot;enable_tracing&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">rv</span><span class="p">[</span><span class="s2">&quot;traces_sample_rate&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-135">        <span class="n">rv</span><span class="p">[</span><span class="s2">&quot;traces_sample_rate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="1-136">
</span><span id="1-137">    <span class="k">if</span> <span class="n">rv</span><span class="p">[</span><span class="s2">&quot;event_scrubber&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-138">        <span class="n">rv</span><span class="p">[</span><span class="s2">&quot;event_scrubber&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">EventScrubber</span><span class="p">()</span>
</span><span id="1-139">
</span><span id="1-140">    <span class="k">return</span> <span class="n">rv</span>
</span><span id="1-141">
</span><span id="1-142">
</span><span id="1-143"><span class="k">try</span><span class="p">:</span>
</span><span id="1-144">    <span class="c1"># Python 3.6+</span>
</span><span id="1-145">    <span class="n">module_not_found_error</span> <span class="o">=</span> <span class="ne">ModuleNotFoundError</span>
</span><span id="1-146"><span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span><span id="1-147">    <span class="c1"># Older Python versions</span>
</span><span id="1-148">    <span class="n">module_not_found_error</span> <span class="o">=</span> <span class="ne">ImportError</span>  <span class="c1"># type: ignore</span>
</span><span id="1-149">
</span><span id="1-150">
</span><span id="1-151"><span class="k">class</span> <span class="nc">_Client</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span id="1-152"><span class="w">    </span><span class="sd">&quot;&quot;&quot;The client is internally responsible for capturing the events and</span>
</span><span id="1-153"><span class="sd">    forwarding them to sentry through the configured transport.  It takes</span>
</span><span id="1-154"><span class="sd">    the client options as keyword arguments and optionally the DSN as first</span>
</span><span id="1-155"><span class="sd">    argument.</span>
</span><span id="1-156"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-157">
</span><span id="1-158">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="1-159">        <span class="c1"># type: (*Any, **Any) -&gt; None</span>
</span><span id="1-160">        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">get_options</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># type: Dict[str, Any]</span>
</span><span id="1-161">
</span><span id="1-162">        <span class="bp">self</span><span class="o">.</span><span class="n">_init_impl</span><span class="p">()</span>
</span><span id="1-163">
</span><span id="1-164">    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="1-165">        <span class="c1"># type: () -&gt; Any</span>
</span><span id="1-166">        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">}</span>
</span><span id="1-167">
</span><span id="1-168">    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
</span><span id="1-169">        <span class="c1"># type: (Any) -&gt; None</span>
</span><span id="1-170">        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;options&quot;</span><span class="p">]</span>
</span><span id="1-171">        <span class="bp">self</span><span class="o">.</span><span class="n">_init_impl</span><span class="p">()</span>
</span><span id="1-172">
</span><span id="1-173">    <span class="k">def</span> <span class="nf">_setup_instrumentation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">functions_to_trace</span><span class="p">):</span>
</span><span id="1-174">        <span class="c1"># type: (Sequence[Dict[str, str]]) -&gt; None</span>
</span><span id="1-175"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="1-176"><span class="sd">        Instruments the functions given in the list `functions_to_trace` with the `@sentry_sdk.tracing.trace` decorator.</span>
</span><span id="1-177"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-178">        <span class="k">for</span> <span class="n">function</span> <span class="ow">in</span> <span class="n">functions_to_trace</span><span class="p">:</span>
</span><span id="1-179">            <span class="n">class_name</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="1-180">            <span class="n">function_qualname</span> <span class="o">=</span> <span class="n">function</span><span class="p">[</span><span class="s2">&quot;qualified_name&quot;</span><span class="p">]</span>
</span><span id="1-181">            <span class="n">module_name</span><span class="p">,</span> <span class="n">function_name</span> <span class="o">=</span> <span class="n">function_qualname</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="1-182">
</span><span id="1-183">            <span class="k">try</span><span class="p">:</span>
</span><span id="1-184">                <span class="c1"># Try to import module and function</span>
</span><span id="1-185">                <span class="c1"># ex: &quot;mymodule.submodule.funcname&quot;</span>
</span><span id="1-186">
</span><span id="1-187">                <span class="n">module_obj</span> <span class="o">=</span> <span class="n">import_module</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>
</span><span id="1-188">                <span class="n">function_obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module_obj</span><span class="p">,</span> <span class="n">function_name</span><span class="p">)</span>
</span><span id="1-189">                <span class="nb">setattr</span><span class="p">(</span><span class="n">module_obj</span><span class="p">,</span> <span class="n">function_name</span><span class="p">,</span> <span class="n">trace</span><span class="p">(</span><span class="n">function_obj</span><span class="p">))</span>
</span><span id="1-190">                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Enabled tracing for </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">function_qualname</span><span class="p">)</span>
</span><span id="1-191">
</span><span id="1-192">            <span class="k">except</span> <span class="n">module_not_found_error</span><span class="p">:</span>
</span><span id="1-193">                <span class="k">try</span><span class="p">:</span>
</span><span id="1-194">                    <span class="c1"># Try to import a class</span>
</span><span id="1-195">                    <span class="c1"># ex: &quot;mymodule.submodule.MyClassName.member_function&quot;</span>
</span><span id="1-196">
</span><span id="1-197">                    <span class="n">module_name</span><span class="p">,</span> <span class="n">class_name</span> <span class="o">=</span> <span class="n">module_name</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="1-198">                    <span class="n">module_obj</span> <span class="o">=</span> <span class="n">import_module</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>
</span><span id="1-199">                    <span class="n">class_obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module_obj</span><span class="p">,</span> <span class="n">class_name</span><span class="p">)</span>
</span><span id="1-200">                    <span class="n">function_obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">class_obj</span><span class="p">,</span> <span class="n">function_name</span><span class="p">)</span>
</span><span id="1-201">                    <span class="nb">setattr</span><span class="p">(</span><span class="n">class_obj</span><span class="p">,</span> <span class="n">function_name</span><span class="p">,</span> <span class="n">trace</span><span class="p">(</span><span class="n">function_obj</span><span class="p">))</span>
</span><span id="1-202">                    <span class="nb">setattr</span><span class="p">(</span><span class="n">module_obj</span><span class="p">,</span> <span class="n">class_name</span><span class="p">,</span> <span class="n">class_obj</span><span class="p">)</span>
</span><span id="1-203">                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Enabled tracing for </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">function_qualname</span><span class="p">)</span>
</span><span id="1-204">
</span><span id="1-205">                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="1-206">                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="1-207">                        <span class="s2">&quot;Can not enable tracing for &#39;</span><span class="si">%s</span><span class="s2">&#39;. (</span><span class="si">%s</span><span class="s2">) Please check your `functions_to_trace` parameter.&quot;</span><span class="p">,</span>
</span><span id="1-208">                        <span class="n">function_qualname</span><span class="p">,</span>
</span><span id="1-209">                        <span class="n">e</span><span class="p">,</span>
</span><span id="1-210">                    <span class="p">)</span>
</span><span id="1-211">
</span><span id="1-212">            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="1-213">                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="1-214">                    <span class="s2">&quot;Can not enable tracing for &#39;</span><span class="si">%s</span><span class="s2">&#39;. (</span><span class="si">%s</span><span class="s2">) Please check your `functions_to_trace` parameter.&quot;</span><span class="p">,</span>
</span><span id="1-215">                    <span class="n">function_qualname</span><span class="p">,</span>
</span><span id="1-216">                    <span class="n">e</span><span class="p">,</span>
</span><span id="1-217">                <span class="p">)</span>
</span><span id="1-218">
</span><span id="1-219">    <span class="k">def</span> <span class="nf">_init_impl</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="1-220">        <span class="c1"># type: () -&gt; None</span>
</span><span id="1-221">        <span class="n">old_debug</span> <span class="o">=</span> <span class="n">_client_init_debug</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="1-222">
</span><span id="1-223">        <span class="k">def</span> <span class="nf">_capture_envelope</span><span class="p">(</span><span class="n">envelope</span><span class="p">):</span>
</span><span id="1-224">            <span class="c1"># type: (Envelope) -&gt; None</span>
</span><span id="1-225">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transport</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-226">                <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">capture_envelope</span><span class="p">(</span><span class="n">envelope</span><span class="p">)</span>
</span><span id="1-227">
</span><span id="1-228">        <span class="k">try</span><span class="p">:</span>
</span><span id="1-229">            <span class="n">_client_init_debug</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;debug&quot;</span><span class="p">])</span>
</span><span id="1-230">            <span class="bp">self</span><span class="o">.</span><span class="n">transport</span> <span class="o">=</span> <span class="n">make_transport</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)</span>
</span><span id="1-231">
</span><span id="1-232">            <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="1-233">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="p">:</span>
</span><span id="1-234">                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;enable_backpressure_handling&quot;</span><span class="p">]:</span>
</span><span id="1-235">                    <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span> <span class="o">=</span> <span class="n">Monitor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="p">)</span>
</span><span id="1-236">
</span><span id="1-237">            <span class="bp">self</span><span class="o">.</span><span class="n">session_flusher</span> <span class="o">=</span> <span class="n">SessionFlusher</span><span class="p">(</span><span class="n">capture_func</span><span class="o">=</span><span class="n">_capture_envelope</span><span class="p">)</span>
</span><span id="1-238">
</span><span id="1-239">            <span class="bp">self</span><span class="o">.</span><span class="n">metrics_aggregator</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Optional[MetricsAggregator]</span>
</span><span id="1-240">            <span class="n">experiments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_experiments&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="1-241">            <span class="k">if</span> <span class="n">experiments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;enable_metrics&quot;</span><span class="p">):</span>
</span><span id="1-242">                <span class="kn">from</span> <span class="nn">sentry_sdk.metrics</span> <span class="kn">import</span> <span class="n">MetricsAggregator</span>
</span><span id="1-243">
</span><span id="1-244">                <span class="bp">self</span><span class="o">.</span><span class="n">metrics_aggregator</span> <span class="o">=</span> <span class="n">MetricsAggregator</span><span class="p">(</span>
</span><span id="1-245">                    <span class="n">capture_func</span><span class="o">=</span><span class="n">_capture_envelope</span><span class="p">,</span>
</span><span id="1-246">                    <span class="n">enable_code_locations</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span>
</span><span id="1-247">                        <span class="n">experiments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;metric_code_locations&quot;</span><span class="p">)</span>
</span><span id="1-248">                    <span class="p">),</span>
</span><span id="1-249">                <span class="p">)</span>
</span><span id="1-250">
</span><span id="1-251">            <span class="n">max_request_body_size</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;always&quot;</span><span class="p">,</span> <span class="s2">&quot;never&quot;</span><span class="p">,</span> <span class="s2">&quot;small&quot;</span><span class="p">,</span> <span class="s2">&quot;medium&quot;</span><span class="p">)</span>
</span><span id="1-252">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;max_request_body_size&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">max_request_body_size</span><span class="p">:</span>
</span><span id="1-253">                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="1-254">                    <span class="s2">&quot;Invalid value for max_request_body_size. Must be one of </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="1-255">                        <span class="n">max_request_body_size</span>
</span><span id="1-256">                    <span class="p">)</span>
</span><span id="1-257">                <span class="p">)</span>
</span><span id="1-258">
</span><span id="1-259">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;_experiments&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;otel_powered_performance&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
</span><span id="1-260">                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="1-261">                    <span class="s2">&quot;[OTel] Enabling experimental OTel-powered performance monitoring.&quot;</span>
</span><span id="1-262">                <span class="p">)</span>
</span><span id="1-263">                <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;instrumenter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">INSTRUMENTER</span><span class="o">.</span><span class="n">OTEL</span>
</span><span id="1-264">                <span class="n">_DEFAULT_INTEGRATIONS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="1-265">                    <span class="s2">&quot;sentry_sdk.integrations.opentelemetry.integration.OpenTelemetryIntegration&quot;</span><span class="p">,</span>
</span><span id="1-266">                <span class="p">)</span>
</span><span id="1-267">
</span><span id="1-268">            <span class="bp">self</span><span class="o">.</span><span class="n">integrations</span> <span class="o">=</span> <span class="n">setup_integrations</span><span class="p">(</span>
</span><span id="1-269">                <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;integrations&quot;</span><span class="p">],</span>
</span><span id="1-270">                <span class="n">with_defaults</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;default_integrations&quot;</span><span class="p">],</span>
</span><span id="1-271">                <span class="n">with_auto_enabling_integrations</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span>
</span><span id="1-272">                    <span class="s2">&quot;auto_enabling_integrations&quot;</span>
</span><span id="1-273">                <span class="p">],</span>
</span><span id="1-274">            <span class="p">)</span>
</span><span id="1-275">
</span><span id="1-276">            <span class="bp">self</span><span class="o">.</span><span class="n">spotlight</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="1-277">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;spotlight&quot;</span><span class="p">):</span>
</span><span id="1-278">                <span class="bp">self</span><span class="o">.</span><span class="n">spotlight</span> <span class="o">=</span> <span class="n">setup_spotlight</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)</span>
</span><span id="1-279">
</span><span id="1-280">            <span class="n">sdk_name</span> <span class="o">=</span> <span class="n">get_sdk_name</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">integrations</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
</span><span id="1-281">            <span class="n">SDK_INFO</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sdk_name</span>
</span><span id="1-282">            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Setting SDK name to &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">sdk_name</span><span class="p">)</span>
</span><span id="1-283">
</span><span id="1-284">            <span class="k">if</span> <span class="n">has_profiling_enabled</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">):</span>
</span><span id="1-285">                <span class="k">try</span><span class="p">:</span>
</span><span id="1-286">                    <span class="n">setup_profiler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)</span>
</span><span id="1-287">                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="1-288">                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Can not set up profiler. (</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span id="1-289">
</span><span id="1-290">        <span class="k">finally</span><span class="p">:</span>
</span><span id="1-291">            <span class="n">_client_init_debug</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">old_debug</span><span class="p">)</span>
</span><span id="1-292">
</span><span id="1-293">        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_instrumentation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;functions_to_trace&quot;</span><span class="p">,</span> <span class="p">[]))</span>
</span><span id="1-294">
</span><span id="1-295">    <span class="nd">@property</span>
</span><span id="1-296">    <span class="k">def</span> <span class="nf">dsn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="1-297">        <span class="c1"># type: () -&gt; Optional[str]</span>
</span><span id="1-298"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the configured DSN as string.&quot;&quot;&quot;</span>
</span><span id="1-299">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;dsn&quot;</span><span class="p">]</span>
</span><span id="1-300">
</span><span id="1-301">    <span class="k">def</span> <span class="nf">_prepare_event</span><span class="p">(</span>
</span><span id="1-302">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-303">        <span class="n">event</span><span class="p">,</span>  <span class="c1"># type: Event</span>
</span><span id="1-304">        <span class="n">hint</span><span class="p">,</span>  <span class="c1"># type: Hint</span>
</span><span id="1-305">        <span class="n">scope</span><span class="p">,</span>  <span class="c1"># type: Optional[Scope]</span>
</span><span id="1-306">    <span class="p">):</span>
</span><span id="1-307">        <span class="c1"># type: (...) -&gt; Optional[Event]</span>
</span><span id="1-308">
</span><span id="1-309">        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-310">            <span class="n">event</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime_utcnow</span><span class="p">()</span>
</span><span id="1-311">
</span><span id="1-312">        <span class="k">if</span> <span class="n">scope</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-313">            <span class="n">is_transaction</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;transaction&quot;</span>
</span><span id="1-314">            <span class="n">event_</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">apply_to_event</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">hint</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)</span>
</span><span id="1-315">
</span><span id="1-316">            <span class="c1"># one of the event/error processors returned None</span>
</span><span id="1-317">            <span class="k">if</span> <span class="n">event_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-318">                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="p">:</span>
</span><span id="1-319">                    <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">record_lost_event</span><span class="p">(</span>
</span><span id="1-320">                        <span class="s2">&quot;event_processor&quot;</span><span class="p">,</span>
</span><span id="1-321">                        <span class="n">data_category</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;transaction&quot;</span> <span class="k">if</span> <span class="n">is_transaction</span> <span class="k">else</span> <span class="s2">&quot;error&quot;</span><span class="p">),</span>
</span><span id="1-322">                    <span class="p">)</span>
</span><span id="1-323">                <span class="k">return</span> <span class="kc">None</span>
</span><span id="1-324">
</span><span id="1-325">            <span class="n">event</span> <span class="o">=</span> <span class="n">event_</span>
</span><span id="1-326">
</span><span id="1-327">        <span class="k">if</span> <span class="p">(</span>
</span><span id="1-328">            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;attach_stacktrace&quot;</span><span class="p">]</span>
</span><span id="1-329">            <span class="ow">and</span> <span class="s2">&quot;exception&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">event</span>
</span><span id="1-330">            <span class="ow">and</span> <span class="s2">&quot;stacktrace&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">event</span>
</span><span id="1-331">            <span class="ow">and</span> <span class="s2">&quot;threads&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">event</span>
</span><span id="1-332">        <span class="p">):</span>
</span><span id="1-333">            <span class="k">with</span> <span class="n">capture_internal_exceptions</span><span class="p">():</span>
</span><span id="1-334">                <span class="n">event</span><span class="p">[</span><span class="s2">&quot;threads&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="1-335">                    <span class="s2">&quot;values&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="1-336">                        <span class="p">{</span>
</span><span id="1-337">                            <span class="s2">&quot;stacktrace&quot;</span><span class="p">:</span> <span class="n">current_stacktrace</span><span class="p">(</span>
</span><span id="1-338">                                <span class="n">include_local_variables</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span id="1-339">                                    <span class="s2">&quot;include_local_variables&quot;</span><span class="p">,</span> <span class="kc">True</span>
</span><span id="1-340">                                <span class="p">),</span>
</span><span id="1-341">                                <span class="n">max_value_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span id="1-342">                                    <span class="s2">&quot;max_value_length&quot;</span><span class="p">,</span> <span class="n">DEFAULT_MAX_VALUE_LENGTH</span>
</span><span id="1-343">                                <span class="p">),</span>
</span><span id="1-344">                            <span class="p">),</span>
</span><span id="1-345">                            <span class="s2">&quot;crashed&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="1-346">                            <span class="s2">&quot;current&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="1-347">                        <span class="p">}</span>
</span><span id="1-348">                    <span class="p">]</span>
</span><span id="1-349">                <span class="p">}</span>
</span><span id="1-350">
</span><span id="1-351">        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="s2">&quot;release&quot;</span><span class="p">,</span> <span class="s2">&quot;environment&quot;</span><span class="p">,</span> <span class="s2">&quot;server_name&quot;</span><span class="p">,</span> <span class="s2">&quot;dist&quot;</span><span class="p">:</span>
</span><span id="1-352">            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-353">                <span class="n">event</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">text_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="n">key</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="1-354">        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sdk&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-355">            <span class="n">sdk_info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">SDK_INFO</span><span class="p">)</span>
</span><span id="1-356">            <span class="n">sdk_info</span><span class="p">[</span><span class="s2">&quot;integrations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">integrations</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="1-357">            <span class="n">event</span><span class="p">[</span><span class="s2">&quot;sdk&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sdk_info</span>
</span><span id="1-358">
</span><span id="1-359">        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;platform&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-360">            <span class="n">event</span><span class="p">[</span><span class="s2">&quot;platform&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;python&quot;</span>
</span><span id="1-361">
</span><span id="1-362">        <span class="n">event</span> <span class="o">=</span> <span class="n">handle_in_app</span><span class="p">(</span>
</span><span id="1-363">            <span class="n">event</span><span class="p">,</span>
</span><span id="1-364">            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;in_app_exclude&quot;</span><span class="p">],</span>
</span><span id="1-365">            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;in_app_include&quot;</span><span class="p">],</span>
</span><span id="1-366">            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;project_root&quot;</span><span class="p">],</span>
</span><span id="1-367">        <span class="p">)</span>
</span><span id="1-368">
</span><span id="1-369">        <span class="k">if</span> <span class="n">event</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-370">            <span class="n">event_scrubber</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;event_scrubber&quot;</span><span class="p">]</span>
</span><span id="1-371">            <span class="k">if</span> <span class="n">event_scrubber</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;send_default_pii&quot;</span><span class="p">]:</span>
</span><span id="1-372">                <span class="n">event_scrubber</span><span class="o">.</span><span class="n">scrub_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</span><span id="1-373">
</span><span id="1-374">        <span class="c1"># Postprocess the event here so that annotated types do</span>
</span><span id="1-375">        <span class="c1"># generally not surface in before_send</span>
</span><span id="1-376">        <span class="k">if</span> <span class="n">event</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-377">            <span class="n">event</span> <span class="o">=</span> <span class="n">serialize</span><span class="p">(</span>
</span><span id="1-378">                <span class="n">event</span><span class="p">,</span>
</span><span id="1-379">                <span class="n">max_request_body_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_request_body_size&quot;</span><span class="p">),</span>
</span><span id="1-380">                <span class="n">max_value_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_value_length&quot;</span><span class="p">),</span>
</span><span id="1-381">            <span class="p">)</span>
</span><span id="1-382">
</span><span id="1-383">        <span class="n">before_send</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;before_send&quot;</span><span class="p">]</span>
</span><span id="1-384">        <span class="k">if</span> <span class="p">(</span>
</span><span id="1-385">            <span class="n">before_send</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="1-386">            <span class="ow">and</span> <span class="n">event</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="1-387">            <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;transaction&quot;</span>
</span><span id="1-388">        <span class="p">):</span>
</span><span id="1-389">            <span class="n">new_event</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="1-390">            <span class="k">with</span> <span class="n">capture_internal_exceptions</span><span class="p">():</span>
</span><span id="1-391">                <span class="n">new_event</span> <span class="o">=</span> <span class="n">before_send</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">hint</span> <span class="ow">or</span> <span class="p">{})</span>
</span><span id="1-392">            <span class="k">if</span> <span class="n">new_event</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-393">                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;before send dropped event&quot;</span><span class="p">)</span>
</span><span id="1-394">                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="p">:</span>
</span><span id="1-395">                    <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">record_lost_event</span><span class="p">(</span>
</span><span id="1-396">                        <span class="s2">&quot;before_send&quot;</span><span class="p">,</span> <span class="n">data_category</span><span class="o">=</span><span class="s2">&quot;error&quot;</span>
</span><span id="1-397">                    <span class="p">)</span>
</span><span id="1-398">            <span class="n">event</span> <span class="o">=</span> <span class="n">new_event</span>  <span class="c1"># type: ignore</span>
</span><span id="1-399">
</span><span id="1-400">        <span class="n">before_send_transaction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;before_send_transaction&quot;</span><span class="p">]</span>
</span><span id="1-401">        <span class="k">if</span> <span class="p">(</span>
</span><span id="1-402">            <span class="n">before_send_transaction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="1-403">            <span class="ow">and</span> <span class="n">event</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="1-404">            <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;transaction&quot;</span>
</span><span id="1-405">        <span class="p">):</span>
</span><span id="1-406">            <span class="n">new_event</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="1-407">            <span class="k">with</span> <span class="n">capture_internal_exceptions</span><span class="p">():</span>
</span><span id="1-408">                <span class="n">new_event</span> <span class="o">=</span> <span class="n">before_send_transaction</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">hint</span> <span class="ow">or</span> <span class="p">{})</span>
</span><span id="1-409">            <span class="k">if</span> <span class="n">new_event</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-410">                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;before send transaction dropped event&quot;</span><span class="p">)</span>
</span><span id="1-411">                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="p">:</span>
</span><span id="1-412">                    <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">record_lost_event</span><span class="p">(</span>
</span><span id="1-413">                        <span class="s2">&quot;before_send&quot;</span><span class="p">,</span> <span class="n">data_category</span><span class="o">=</span><span class="s2">&quot;transaction&quot;</span>
</span><span id="1-414">                    <span class="p">)</span>
</span><span id="1-415">            <span class="n">event</span> <span class="o">=</span> <span class="n">new_event</span>  <span class="c1"># type: ignore</span>
</span><span id="1-416">
</span><span id="1-417">        <span class="k">return</span> <span class="n">event</span>
</span><span id="1-418">
</span><span id="1-419">    <span class="k">def</span> <span class="nf">_is_ignored_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">hint</span><span class="p">):</span>
</span><span id="1-420">        <span class="c1"># type: (Event, Hint) -&gt; bool</span>
</span><span id="1-421">        <span class="n">exc_info</span> <span class="o">=</span> <span class="n">hint</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;exc_info&quot;</span><span class="p">)</span>
</span><span id="1-422">        <span class="k">if</span> <span class="n">exc_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-423">            <span class="k">return</span> <span class="kc">False</span>
</span><span id="1-424">
</span><span id="1-425">        <span class="n">error</span> <span class="o">=</span> <span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="1-426">        <span class="n">error_type_name</span> <span class="o">=</span> <span class="n">get_type_name</span><span class="p">(</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="1-427">        <span class="n">error_full_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span> <span class="n">error_type_name</span><span class="p">)</span>
</span><span id="1-428">
</span><span id="1-429">        <span class="k">for</span> <span class="n">ignored_error</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;ignore_errors&quot;</span><span class="p">]:</span>
</span><span id="1-430">            <span class="c1"># String types are matched against the type name in the</span>
</span><span id="1-431">            <span class="c1"># exception only</span>
</span><span id="1-432">            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ignored_error</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
</span><span id="1-433">                <span class="k">if</span> <span class="n">ignored_error</span> <span class="o">==</span> <span class="n">error_full_name</span> <span class="ow">or</span> <span class="n">ignored_error</span> <span class="o">==</span> <span class="n">error_type_name</span><span class="p">:</span>
</span><span id="1-434">                    <span class="k">return</span> <span class="kc">True</span>
</span><span id="1-435">            <span class="k">else</span><span class="p">:</span>
</span><span id="1-436">                <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">ignored_error</span><span class="p">):</span>
</span><span id="1-437">                    <span class="k">return</span> <span class="kc">True</span>
</span><span id="1-438">
</span><span id="1-439">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="1-440">
</span><span id="1-441">    <span class="k">def</span> <span class="nf">_should_capture</span><span class="p">(</span>
</span><span id="1-442">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-443">        <span class="n">event</span><span class="p">,</span>  <span class="c1"># type: Event</span>
</span><span id="1-444">        <span class="n">hint</span><span class="p">,</span>  <span class="c1"># type: Hint</span>
</span><span id="1-445">        <span class="n">scope</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># type: Optional[Scope]</span>
</span><span id="1-446">    <span class="p">):</span>
</span><span id="1-447">        <span class="c1"># type: (...) -&gt; bool</span>
</span><span id="1-448">        <span class="c1"># Transactions are sampled independent of error events.</span>
</span><span id="1-449">        <span class="n">is_transaction</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;transaction&quot;</span>
</span><span id="1-450">        <span class="k">if</span> <span class="n">is_transaction</span><span class="p">:</span>
</span><span id="1-451">            <span class="k">return</span> <span class="kc">True</span>
</span><span id="1-452">
</span><span id="1-453">        <span class="n">ignoring_prevents_recursion</span> <span class="o">=</span> <span class="n">scope</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">scope</span><span class="o">.</span><span class="n">_should_capture</span>
</span><span id="1-454">        <span class="k">if</span> <span class="n">ignoring_prevents_recursion</span><span class="p">:</span>
</span><span id="1-455">            <span class="k">return</span> <span class="kc">False</span>
</span><span id="1-456">
</span><span id="1-457">        <span class="n">ignored_by_config_option</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_ignored_error</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">hint</span><span class="p">)</span>
</span><span id="1-458">        <span class="k">if</span> <span class="n">ignored_by_config_option</span><span class="p">:</span>
</span><span id="1-459">            <span class="k">return</span> <span class="kc">False</span>
</span><span id="1-460">
</span><span id="1-461">        <span class="k">return</span> <span class="kc">True</span>
</span><span id="1-462">
</span><span id="1-463">    <span class="k">def</span> <span class="nf">_should_sample_error</span><span class="p">(</span>
</span><span id="1-464">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-465">        <span class="n">event</span><span class="p">,</span>  <span class="c1"># type: Event</span>
</span><span id="1-466">        <span class="n">hint</span><span class="p">,</span>  <span class="c1"># type: Hint</span>
</span><span id="1-467">    <span class="p">):</span>
</span><span id="1-468">        <span class="c1"># type: (...) -&gt; bool</span>
</span><span id="1-469">        <span class="n">error_sampler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error_sampler&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="1-470">
</span><span id="1-471">        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">error_sampler</span><span class="p">):</span>
</span><span id="1-472">            <span class="k">with</span> <span class="n">capture_internal_exceptions</span><span class="p">():</span>
</span><span id="1-473">                <span class="n">sample_rate</span> <span class="o">=</span> <span class="n">error_sampler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">hint</span><span class="p">)</span>
</span><span id="1-474">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-475">            <span class="n">sample_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;sample_rate&quot;</span><span class="p">]</span>
</span><span id="1-476">
</span><span id="1-477">        <span class="k">try</span><span class="p">:</span>
</span><span id="1-478">            <span class="n">not_in_sample_rate</span> <span class="o">=</span> <span class="n">sample_rate</span> <span class="o">&lt;</span> <span class="mf">1.0</span> <span class="ow">and</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">sample_rate</span>
</span><span id="1-479">        <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
</span><span id="1-480">            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="1-481">                <span class="s2">&quot;The provided error_sampler raised an error. Defaulting to sampling the event.&quot;</span>
</span><span id="1-482">            <span class="p">)</span>
</span><span id="1-483">
</span><span id="1-484">            <span class="c1"># If the error_sampler raised an error, we should sample the event, since the default behavior</span>
</span><span id="1-485">            <span class="c1"># (when no sample_rate or error_sampler is provided) is to sample all events.</span>
</span><span id="1-486">            <span class="n">not_in_sample_rate</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-487">        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
</span><span id="1-488">            <span class="n">parameter</span><span class="p">,</span> <span class="n">verb</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="1-489">                <span class="p">(</span><span class="s2">&quot;error_sampler&quot;</span><span class="p">,</span> <span class="s2">&quot;returned&quot;</span><span class="p">)</span>
</span><span id="1-490">                <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">error_sampler</span><span class="p">)</span>
</span><span id="1-491">                <span class="k">else</span> <span class="p">(</span><span class="s2">&quot;sample_rate&quot;</span><span class="p">,</span> <span class="s2">&quot;contains&quot;</span><span class="p">)</span>
</span><span id="1-492">            <span class="p">)</span>
</span><span id="1-493">            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
</span><span id="1-494">                <span class="s2">&quot;The provided </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> an invalid value of </span><span class="si">%s</span><span class="s2">. The value should be a float or a bool. Defaulting to sampling the event.&quot;</span>
</span><span id="1-495">                <span class="o">%</span> <span class="p">(</span><span class="n">parameter</span><span class="p">,</span> <span class="n">verb</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">sample_rate</span><span class="p">))</span>
</span><span id="1-496">            <span class="p">)</span>
</span><span id="1-497">
</span><span id="1-498">            <span class="c1"># If the sample_rate has an invalid value, we should sample the event, since the default behavior</span>
</span><span id="1-499">            <span class="c1"># (when no sample_rate or error_sampler is provided) is to sample all events.</span>
</span><span id="1-500">            <span class="n">not_in_sample_rate</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-501">
</span><span id="1-502">        <span class="k">if</span> <span class="n">not_in_sample_rate</span><span class="p">:</span>
</span><span id="1-503">            <span class="c1"># because we will not sample this event, record a &quot;lost event&quot;.</span>
</span><span id="1-504">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="p">:</span>
</span><span id="1-505">                <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">record_lost_event</span><span class="p">(</span><span class="s2">&quot;sample_rate&quot;</span><span class="p">,</span> <span class="n">data_category</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
</span><span id="1-506">
</span><span id="1-507">            <span class="k">return</span> <span class="kc">False</span>
</span><span id="1-508">
</span><span id="1-509">        <span class="k">return</span> <span class="kc">True</span>
</span><span id="1-510">
</span><span id="1-511">    <span class="k">def</span> <span class="nf">_update_session_from_event</span><span class="p">(</span>
</span><span id="1-512">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-513">        <span class="n">session</span><span class="p">,</span>  <span class="c1"># type: Session</span>
</span><span id="1-514">        <span class="n">event</span><span class="p">,</span>  <span class="c1"># type: Event</span>
</span><span id="1-515">    <span class="p">):</span>
</span><span id="1-516">        <span class="c1"># type: (...) -&gt; None</span>
</span><span id="1-517">
</span><span id="1-518">        <span class="n">crashed</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-519">        <span class="n">errored</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-520">        <span class="n">user_agent</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="1-521">
</span><span id="1-522">        <span class="n">exceptions</span> <span class="o">=</span> <span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;exception&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;values&quot;</span><span class="p">)</span>
</span><span id="1-523">        <span class="k">if</span> <span class="n">exceptions</span><span class="p">:</span>
</span><span id="1-524">            <span class="n">errored</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="1-525">            <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">exceptions</span><span class="p">:</span>
</span><span id="1-526">                <span class="n">mechanism</span> <span class="o">=</span> <span class="n">error</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mechanism&quot;</span><span class="p">)</span>
</span><span id="1-527">                <span class="k">if</span> <span class="n">mechanism</span> <span class="ow">and</span> <span class="n">mechanism</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;handled&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
</span><span id="1-528">                    <span class="n">crashed</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="1-529">                    <span class="k">break</span>
</span><span id="1-530">
</span><span id="1-531">        <span class="n">user</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user&quot;</span><span class="p">)</span>
</span><span id="1-532">
</span><span id="1-533">        <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">user_agent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-534">            <span class="n">headers</span> <span class="o">=</span> <span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;headers&quot;</span><span class="p">)</span>
</span><span id="1-535">            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">headers</span> <span class="ow">or</span> <span class="p">{}):</span>
</span><span id="1-536">                <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;user-agent&quot;</span><span class="p">:</span>
</span><span id="1-537">                    <span class="n">user_agent</span> <span class="o">=</span> <span class="n">v</span>
</span><span id="1-538">                    <span class="k">break</span>
</span><span id="1-539">
</span><span id="1-540">        <span class="n">session</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
</span><span id="1-541">            <span class="n">status</span><span class="o">=</span><span class="s2">&quot;crashed&quot;</span> <span class="k">if</span> <span class="n">crashed</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-542">            <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
</span><span id="1-543">            <span class="n">user_agent</span><span class="o">=</span><span class="n">user_agent</span><span class="p">,</span>
</span><span id="1-544">            <span class="n">errors</span><span class="o">=</span><span class="n">session</span><span class="o">.</span><span class="n">errors</span> <span class="o">+</span> <span class="p">(</span><span class="n">errored</span> <span class="ow">or</span> <span class="n">crashed</span><span class="p">),</span>
</span><span id="1-545">        <span class="p">)</span>
</span><span id="1-546">
</span><span id="1-547">    <span class="k">def</span> <span class="nf">capture_event</span><span class="p">(</span>
</span><span id="1-548">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-549">        <span class="n">event</span><span class="p">,</span>  <span class="c1"># type: Event</span>
</span><span id="1-550">        <span class="n">hint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># type: Optional[Hint]</span>
</span><span id="1-551">        <span class="n">scope</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># type: Optional[Scope]</span>
</span><span id="1-552">    <span class="p">):</span>
</span><span id="1-553">        <span class="c1"># type: (...) -&gt; Optional[str]</span>
</span><span id="1-554"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Captures an event.</span>
</span><span id="1-555">
</span><span id="1-556"><span class="sd">        :param event: A ready-made event that can be directly sent to Sentry.</span>
</span><span id="1-557">
</span><span id="1-558"><span class="sd">        :param hint: Contains metadata about the event that can be read from `before_send`, such as the original exception object or a HTTP request object.</span>
</span><span id="1-559">
</span><span id="1-560"><span class="sd">        :param scope: An optional scope to use for determining whether this event</span>
</span><span id="1-561"><span class="sd">            should be captured.</span>
</span><span id="1-562">
</span><span id="1-563"><span class="sd">        :returns: An event ID. May be `None` if there is no DSN set or of if the SDK decided to discard the event for other reasons. In such situations setting `debug=True` on `init()` may help.</span>
</span><span id="1-564"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-565">        <span class="k">if</span> <span class="n">disable_capture_event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="kc">False</span><span class="p">):</span>
</span><span id="1-566">            <span class="k">return</span> <span class="kc">None</span>
</span><span id="1-567">
</span><span id="1-568">        <span class="k">if</span> <span class="n">hint</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-569">            <span class="n">hint</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="1-570">        <span class="n">event_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;event_id&quot;</span><span class="p">)</span>
</span><span id="1-571">        <span class="n">hint</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">hint</span> <span class="ow">or</span> <span class="p">())</span>  <span class="c1"># type: Hint</span>
</span><span id="1-572">
</span><span id="1-573">        <span class="k">if</span> <span class="n">event_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-574">            <span class="n">event</span><span class="p">[</span><span class="s2">&quot;event_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">event_id</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span>
</span><span id="1-575">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_capture</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">hint</span><span class="p">,</span> <span class="n">scope</span><span class="p">):</span>
</span><span id="1-576">            <span class="k">return</span> <span class="kc">None</span>
</span><span id="1-577">
</span><span id="1-578">        <span class="n">profile</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;profile&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="1-579">
</span><span id="1-580">        <span class="n">event_opt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_event</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">hint</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span>
</span><span id="1-581">        <span class="k">if</span> <span class="n">event_opt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-582">            <span class="k">return</span> <span class="kc">None</span>
</span><span id="1-583">
</span><span id="1-584">        <span class="c1"># whenever we capture an event we also check if the session needs</span>
</span><span id="1-585">        <span class="c1"># to be updated based on that information.</span>
</span><span id="1-586">        <span class="n">session</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">_session</span> <span class="k">if</span> <span class="n">scope</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="1-587">        <span class="k">if</span> <span class="n">session</span><span class="p">:</span>
</span><span id="1-588">            <span class="bp">self</span><span class="o">.</span><span class="n">_update_session_from_event</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>
</span><span id="1-589">
</span><span id="1-590">        <span class="n">is_transaction</span> <span class="o">=</span> <span class="n">event_opt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;transaction&quot;</span>
</span><span id="1-591">        <span class="n">is_checkin</span> <span class="o">=</span> <span class="n">event_opt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;check_in&quot;</span>
</span><span id="1-592">
</span><span id="1-593">        <span class="k">if</span> <span class="p">(</span>
</span><span id="1-594">            <span class="ow">not</span> <span class="n">is_transaction</span>
</span><span id="1-595">            <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_checkin</span>
</span><span id="1-596">            <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_sample_error</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">hint</span><span class="p">)</span>
</span><span id="1-597">        <span class="p">):</span>
</span><span id="1-598">            <span class="k">return</span> <span class="kc">None</span>
</span><span id="1-599">
</span><span id="1-600">        <span class="n">tracing_enabled</span> <span class="o">=</span> <span class="n">has_tracing_enabled</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)</span>
</span><span id="1-601">        <span class="n">attachments</span> <span class="o">=</span> <span class="n">hint</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;attachments&quot;</span><span class="p">)</span>
</span><span id="1-602">
</span><span id="1-603">        <span class="n">trace_context</span> <span class="o">=</span> <span class="n">event_opt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;contexts&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;trace&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
</span><span id="1-604">        <span class="n">dynamic_sampling_context</span> <span class="o">=</span> <span class="n">trace_context</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;dynamic_sampling_context&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="1-605">
</span><span id="1-606">        <span class="c1"># If tracing is enabled all events should go to /envelope endpoint.</span>
</span><span id="1-607">        <span class="c1"># If no tracing is enabled only transactions, events with attachments, and checkins should go to the /envelope endpoint.</span>
</span><span id="1-608">        <span class="n">should_use_envelope_endpoint</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="1-609">            <span class="n">tracing_enabled</span>
</span><span id="1-610">            <span class="ow">or</span> <span class="n">is_transaction</span>
</span><span id="1-611">            <span class="ow">or</span> <span class="n">is_checkin</span>
</span><span id="1-612">            <span class="ow">or</span> <span class="nb">bool</span><span class="p">(</span><span class="n">attachments</span><span class="p">)</span>
</span><span id="1-613">            <span class="ow">or</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spotlight</span><span class="p">)</span>
</span><span id="1-614">        <span class="p">)</span>
</span><span id="1-615">        <span class="k">if</span> <span class="n">should_use_envelope_endpoint</span><span class="p">:</span>
</span><span id="1-616">            <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="1-617">                <span class="s2">&quot;event_id&quot;</span><span class="p">:</span> <span class="n">event_opt</span><span class="p">[</span><span class="s2">&quot;event_id&quot;</span><span class="p">],</span>
</span><span id="1-618">                <span class="s2">&quot;sent_at&quot;</span><span class="p">:</span> <span class="n">format_timestamp</span><span class="p">(</span><span class="n">datetime_utcnow</span><span class="p">()),</span>
</span><span id="1-619">            <span class="p">}</span>
</span><span id="1-620">
</span><span id="1-621">            <span class="k">if</span> <span class="n">dynamic_sampling_context</span><span class="p">:</span>
</span><span id="1-622">                <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;trace&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dynamic_sampling_context</span>
</span><span id="1-623">
</span><span id="1-624">            <span class="n">envelope</span> <span class="o">=</span> <span class="n">Envelope</span><span class="p">(</span><span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
</span><span id="1-625">
</span><span id="1-626">            <span class="k">if</span> <span class="n">is_transaction</span><span class="p">:</span>
</span><span id="1-627">                <span class="k">if</span> <span class="n">profile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-628">                    <span class="n">envelope</span><span class="o">.</span><span class="n">add_profile</span><span class="p">(</span><span class="n">profile</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">event_opt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">))</span>
</span><span id="1-629">                <span class="n">envelope</span><span class="o">.</span><span class="n">add_transaction</span><span class="p">(</span><span class="n">event_opt</span><span class="p">)</span>
</span><span id="1-630">            <span class="k">elif</span> <span class="n">is_checkin</span><span class="p">:</span>
</span><span id="1-631">                <span class="n">envelope</span><span class="o">.</span><span class="n">add_checkin</span><span class="p">(</span><span class="n">event_opt</span><span class="p">)</span>
</span><span id="1-632">            <span class="k">else</span><span class="p">:</span>
</span><span id="1-633">                <span class="n">envelope</span><span class="o">.</span><span class="n">add_event</span><span class="p">(</span><span class="n">event_opt</span><span class="p">)</span>
</span><span id="1-634">
</span><span id="1-635">            <span class="k">for</span> <span class="n">attachment</span> <span class="ow">in</span> <span class="n">attachments</span> <span class="ow">or</span> <span class="p">():</span>
</span><span id="1-636">                <span class="n">envelope</span><span class="o">.</span><span class="n">add_item</span><span class="p">(</span><span class="n">attachment</span><span class="o">.</span><span class="n">to_envelope_item</span><span class="p">())</span>
</span><span id="1-637">
</span><span id="1-638">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spotlight</span><span class="p">:</span>
</span><span id="1-639">                <span class="bp">self</span><span class="o">.</span><span class="n">spotlight</span><span class="o">.</span><span class="n">capture_envelope</span><span class="p">(</span><span class="n">envelope</span><span class="p">)</span>
</span><span id="1-640">
</span><span id="1-641">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transport</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-642">                <span class="k">return</span> <span class="kc">None</span>
</span><span id="1-643">
</span><span id="1-644">            <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">capture_envelope</span><span class="p">(</span><span class="n">envelope</span><span class="p">)</span>
</span><span id="1-645">
</span><span id="1-646">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-647">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transport</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-648">                <span class="k">return</span> <span class="kc">None</span>
</span><span id="1-649">
</span><span id="1-650">            <span class="c1"># All other events go to the legacy /store/ endpoint (will be removed in the future).</span>
</span><span id="1-651">            <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">capture_event</span><span class="p">(</span><span class="n">event_opt</span><span class="p">)</span>
</span><span id="1-652">
</span><span id="1-653">        <span class="k">return</span> <span class="n">event_id</span>
</span><span id="1-654">
</span><span id="1-655">    <span class="k">def</span> <span class="nf">capture_session</span><span class="p">(</span>
</span><span id="1-656">        <span class="bp">self</span><span class="p">,</span> <span class="n">session</span>  <span class="c1"># type: Session</span>
</span><span id="1-657">    <span class="p">):</span>
</span><span id="1-658">        <span class="c1"># type: (...) -&gt; None</span>
</span><span id="1-659">        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">release</span><span class="p">:</span>
</span><span id="1-660">            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Discarded session update because of missing release&quot;</span><span class="p">)</span>
</span><span id="1-661">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-662">            <span class="bp">self</span><span class="o">.</span><span class="n">session_flusher</span><span class="o">.</span><span class="n">add_session</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
</span><span id="1-663">
</span><span id="1-664">    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span>
</span><span id="1-665">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-666">        <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># type: Optional[float]</span>
</span><span id="1-667">        <span class="n">callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># type: Optional[Callable[[int, float], None]]</span>
</span><span id="1-668">    <span class="p">):</span>
</span><span id="1-669">        <span class="c1"># type: (...) -&gt; None</span>
</span><span id="1-670"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="1-671"><span class="sd">        Close the client and shut down the transport. Arguments have the same</span>
</span><span id="1-672"><span class="sd">        semantics as :py:meth:`Client.flush`.</span>
</span><span id="1-673"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-674">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transport</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-675">            <span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">callback</span><span class="p">)</span>
</span><span id="1-676">            <span class="bp">self</span><span class="o">.</span><span class="n">session_flusher</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
</span><span id="1-677">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics_aggregator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-678">                <span class="bp">self</span><span class="o">.</span><span class="n">metrics_aggregator</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
</span><span id="1-679">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span><span class="p">:</span>
</span><span id="1-680">                <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
</span><span id="1-681">            <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
</span><span id="1-682">            <span class="bp">self</span><span class="o">.</span><span class="n">transport</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="1-683">
</span><span id="1-684">    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span>
</span><span id="1-685">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-686">        <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># type: Optional[float]</span>
</span><span id="1-687">        <span class="n">callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># type: Optional[Callable[[int, float], None]]</span>
</span><span id="1-688">    <span class="p">):</span>
</span><span id="1-689">        <span class="c1"># type: (...) -&gt; None</span>
</span><span id="1-690"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="1-691"><span class="sd">        Wait for the current events to be sent.</span>
</span><span id="1-692">
</span><span id="1-693"><span class="sd">        :param timeout: Wait for at most `timeout` seconds. If no `timeout` is provided, the `shutdown_timeout` option value is used.</span>
</span><span id="1-694">
</span><span id="1-695"><span class="sd">        :param callback: Is invoked with the number of pending events and the configured timeout.</span>
</span><span id="1-696"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-697">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transport</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-698">            <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-699">                <span class="n">timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;shutdown_timeout&quot;</span><span class="p">]</span>
</span><span id="1-700">            <span class="bp">self</span><span class="o">.</span><span class="n">session_flusher</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</span><span id="1-701">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics_aggregator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-702">                <span class="bp">self</span><span class="o">.</span><span class="n">metrics_aggregator</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</span><span id="1-703">            <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">flush</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">callback</span><span class="p">)</span>
</span><span id="1-704">
</span><span id="1-705">    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="1-706">        <span class="c1"># type: () -&gt; _Client</span>
</span><span id="1-707">        <span class="k">return</span> <span class="bp">self</span>
</span><span id="1-708">
</span><span id="1-709">    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span>
</span><span id="1-710">        <span class="c1"># type: (Any, Any, Any) -&gt; None</span>
</span><span id="1-711">        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="1-712">
</span><span id="1-713">
</span><span id="1-714"><span class="kn">from</span> <span class="nn">sentry_sdk._types</span> <span class="kn">import</span> <span class="n">TYPE_CHECKING</span>
</span><span id="1-715">
</span><span id="1-716"><span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span id="1-717">    <span class="c1"># Make mypy, PyCharm and other static analyzers think `get_options` is a</span>
</span><span id="1-718">    <span class="c1"># type to have nicer autocompletion for params.</span>
</span><span id="1-719">    <span class="c1">#</span>
</span><span id="1-720">    <span class="c1"># Use `ClientConstructor` to define the argument types of `init` and</span>
</span><span id="1-721">    <span class="c1"># `Dict[str, Any]` to tell static analyzers about the return type.</span>
</span><span id="1-722">
</span><span id="1-723">    <span class="k">class</span> <span class="nc">get_options</span><span class="p">(</span><span class="n">ClientConstructor</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>  <span class="c1"># noqa: N801</span>
</span><span id="1-724">        <span class="k">pass</span>
</span><span id="1-725">
<div class="viewcode-block" id="Client">
<a class="viewcode-back" href="../../apidocs.html#sentry_sdk.Client">[docs]</a>
</span><span id="1-726">    <span class="k">class</span> <span class="nc">Client</span><span class="p">(</span><span class="n">ClientConstructor</span><span class="p">,</span> <span class="n">_Client</span><span class="p">):</span>
</span><span id="1-727">        <span class="k">pass</span></div>

</span><span id="1-728">
</span><span id="1-729"><span class="k">else</span><span class="p">:</span>
</span><span id="1-730">    <span class="c1"># Alias `get_options` for actual usage. Go through the lambda indirection</span>
</span><span id="1-731">    <span class="c1"># to throw PyCharm off of the weakly typed signature (it would otherwise</span>
</span><span id="1-732">    <span class="c1"># discover both the weakly typed signature of `_init` and our faked `init`</span>
</span><span id="1-733">    <span class="c1"># type).</span>
</span><span id="1-734">
</span><span id="1-735">    <span class="n">get_options</span> <span class="o">=</span> <span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">_get_options</span><span class="p">)()</span>
</span><span id="1-736">    <span class="n">Client</span> <span class="o">=</span> <span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">_Client</span><span class="p">)()</span>
</span></pre></div>
        </article>
        
        <div class="navigation flex print:hidden">
  
  
</div>
        
      </div>
    </div>
  </main>
</div>
<footer class="sy-foot">
  <div class="sy-foot-inner sy-container mx-auto">
    
    <div class="sy-foot-reserved md:flex justify-between items-center">
      <div class="sy-foot-copyright"><p>2019-2023, Sentry Team and Contributors</p>
        
        <p>
          Made with
          
          <a href="https://www.sphinx-doc.org/">Sphinx</a> and
          
          <a href="https://shibuya.lepture.com">Shibuya theme</a>.
        </p>
      </div>
      <div class="sy-foot-socials">
          <a href="https://github.com/getsentry/sentry-python" aria-label="GitHub"><i class="i-icon github"></i></a>
      </div>
    </div>
  </div>
</footer></div>
      <script src="../../_static/documentation_options.js?v=d54d59e7"></script>
      <script src="../../_static/doctools.js?v=888ff710"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/shibuya.js?v=3e5c8598"></script>
    
</body>
</html>